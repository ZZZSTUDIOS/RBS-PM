import { useState, useCallback, useEffect } from 'react';
import {
  useAccount,
  usePublicClient,
  useWalletClient,
  useReadContract,
} from 'wagmi';
import { parseEther, formatEther, parseUnits, formatUnits, decodeEventLog, type Address } from 'viem';

export type LogType = 'info' | 'success' | 'error' | 'pending';

export interface LogEntry {
  timestamp: string;
  msg: string;
  type: LogType;
  txHash?: string;
}

export interface LMSRMarketConfig {
  question: string;
  resolutionDate: string;
  oracle: string;
  liquidityParam: string; // e.g., "100" for 100 MON worth of liquidity depth (legacy LMSR)
  yesName: string;
  yesSymbol: string;
  noName: string;
  noSymbol: string;
  initialLiquidity: string; // MON to seed the market
}

// LS-LMSR specific config (extends base config)
export interface LSLMSRMarketConfig {
  question: string;
  resolutionDate: string;
  oracle: string;
  alpha: string; // e.g., "0.03" for 3% max spread
  minLiquidity: string; // e.g., "10" minimum effective b
  initialYesShares: string; // e.g., "100" initial YES shares for bootstrapping
  initialNoShares: string; // e.g., "100" initial NO shares for bootstrapping
  yesName: string;
  yesSymbol: string;
  noName: string;
  noSymbol: string;
  // Liquidity buffer for solvency (minimum 1 MON)
  // Recommended: 2-5% of expected total trading volume
  // Example: Expecting 500 MON total trades â†’ deposit 10-25 MON buffer
  initialLiquidity: string;
}

export interface MarketInfo {
  question: string;
  resolutionTime: bigint;
  oracle: Address;
  yesPrice: bigint;
  noPrice: bigint;
  yesProbability?: bigint; // Softmax probability (without entropy term)
  noProbability?: bigint;
  yesShares: bigint;
  noShares: bigint;
  totalCollateral: bigint;
  resolved: boolean;
  yesWins: boolean;
  collateralDecimals: number; // 18 for native/WMON, 6 for USDC
  collateralSymbol: string;
}

// Extended market info for LS-LMSR
export interface LSLMSRMarketInfo extends MarketInfo {
  yesProbability: bigint;
  noProbability: bigint;
  liquidityParam: bigint;
  priceSum: bigint;
}

// Hook for logging - per wallet, in-memory only (clears on wallet change)
// Trade history comes from Supabase, this is just for real-time transaction feedback
export function useTransactionLog(walletAddress?: string) {
  const [logs, setLogs] = useState<LogEntry[]>([]);
  const [currentWallet, setCurrentWallet] = useState<string | undefined>(undefined);

  // Clear logs when wallet changes
  useEffect(() => {
    if (walletAddress !== currentWallet) {
      setCurrentWallet(walletAddress);
      setLogs([]); // Clear logs when switching wallets
    }
  }, [walletAddress, currentWallet]);

  const addLog = useCallback((msg: string, type: LogType = 'info', txHash?: string) => {
    const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
    setLogs(prev => [...prev, { timestamp, msg, type, txHash }].slice(-100));
  }, []);

  const clearLogs = useCallback(() => setLogs([]), []);

  return { logs, addLog, clearLogs };
}

// LS-LMSR ABI for liquidity-sensitive market maker
export const LSLMSR_ABI = [
  // Constructor
  {
    type: 'constructor',
    inputs: [
      { name: '_question', type: 'string' },
      { name: '_resolutionTime', type: 'uint256' },
      { name: '_oracle', type: 'address' },
      { name: '_alpha', type: 'uint256' },
      { name: '_minLiquidity', type: 'uint256' },
      { name: '_initialYesShares', type: 'uint256' },
      { name: '_initialNoShares', type: 'uint256' },
      { name: '_yesName', type: 'string' },
      { name: '_yesSymbol', type: 'string' },
      { name: '_noName', type: 'string' },
      { name: '_noSymbol', type: 'string' },
    ],
  },
  // View functions
  {
    name: 'getMarketInfo',
    type: 'function',
    inputs: [],
    outputs: [
      { name: '_question', type: 'string' },
      { name: '_resolutionTime', type: 'uint256' },
      { name: '_oracle', type: 'address' },
      { name: '_yesPrice', type: 'uint256' },
      { name: '_noPrice', type: 'uint256' },
      { name: '_yesProbability', type: 'uint256' },
      { name: '_noProbability', type: 'uint256' },
      { name: '_yesShares', type: 'uint256' },
      { name: '_noShares', type: 'uint256' },
      { name: '_totalCollateral', type: 'uint256' },
      { name: '_liquidityParam', type: 'uint256' },
      { name: '_priceSum', type: 'uint256' },
      { name: '_resolved', type: 'bool' },
      { name: '_yesWins', type: 'bool' },
    ],
    stateMutability: 'view',
  },
  {
    name: 'getCost',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'shares', type: 'uint256' },
    ],
    outputs: [{ name: 'cost', type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'estimateSharesForPayment',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'grossPayment', type: 'uint256' },
    ],
    outputs: [{ name: 'shares', type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getPayoutForSell',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'shares', type: 'uint256' },
    ],
    outputs: [{ name: 'payout', type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getYesPrice',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getNoPrice',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getYesProbability',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getNoProbability',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getPriceSum',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'liquidityParameter',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'yesToken',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'address' }],
    stateMutability: 'view',
  },
  {
    name: 'noToken',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'address' }],
    stateMutability: 'view',
  },
  {
    name: 'question',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'string' }],
    stateMutability: 'view',
  },
  {
    name: 'alpha',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'minLiquidity',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'yesShares',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'noShares',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'oracle',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'address' }],
    stateMutability: 'view',
  },
  {
    name: 'resolved',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'bool' }],
    stateMutability: 'view',
  },
  // Write functions
  {
    name: 'buy',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'minShares', type: 'uint256' },
    ],
    outputs: [],
    stateMutability: 'payable',
  },
  {
    name: 'sell',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'shares', type: 'uint256' },
      { name: 'minPayout', type: 'uint256' },
    ],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'resolve',
    type: 'function',
    inputs: [{ name: '_yesWins', type: 'bool' }],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'redeem',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'addLiquidity',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'payable',
  },
  {
    name: 'pause',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'unpause',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  // Fee functions
  {
    name: 'claimProtocolFees',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'claimCreatorFees',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'withdrawExcessCollateral',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'creatorLiquidityBuffer',
    type: 'function',
    inputs: [],
    outputs: [{ name: '', type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getFeeInfo',
    type: 'function',
    inputs: [],
    outputs: [
      { name: 'pendingCreatorFees', type: 'uint256' },
    ],
    stateMutability: 'view',
  },
  {
    name: 'creatorFeesAccrued',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'marketCreator',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'address' }],
    stateMutability: 'view',
  },
  {
    name: 'resolutionTime',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  // Events
  {
    name: 'SharesPurchased',
    type: 'event',
    inputs: [
      { name: 'buyer', type: 'address', indexed: true },
      { name: 'isYes', type: 'bool', indexed: false },
      { name: 'shares', type: 'uint256', indexed: false },
      { name: 'cost', type: 'uint256', indexed: false },
    ],
  },
  {
    name: 'SharesSold',
    type: 'event',
    inputs: [
      { name: 'seller', type: 'address', indexed: true },
      { name: 'isYes', type: 'bool', indexed: false },
      { name: 'shares', type: 'uint256', indexed: false },
      { name: 'payout', type: 'uint256', indexed: false },
    ],
  },
  {
    name: 'Redeemed',
    type: 'event',
    inputs: [
      { name: 'user', type: 'address', indexed: true },
      { name: 'shares', type: 'uint256', indexed: false },
      { name: 'payout', type: 'uint256', indexed: false },
    ],
  },
  {
    name: 'OracleChanged',
    type: 'event',
    inputs: [
      { name: 'oldOracle', type: 'address', indexed: true },
      { name: 'newOracle', type: 'address', indexed: true },
    ],
  },
] as const;

// Legacy LMSR ABI for interactions (kept for backward compatibility)
export const LMSR_ABI = [
  // Constructor
  {
    type: 'constructor',
    inputs: [
      { name: '_question', type: 'string' },
      { name: '_resolutionTime', type: 'uint256' },
      { name: '_oracle', type: 'address' },
      { name: '_liquidityParam', type: 'uint256' },
      { name: '_yesName', type: 'string' },
      { name: '_yesSymbol', type: 'string' },
      { name: '_noName', type: 'string' },
      { name: '_noSymbol', type: 'string' },
    ],
  },
  // View functions
  {
    name: 'getMarketInfo',
    type: 'function',
    inputs: [],
    outputs: [
      { name: '_question', type: 'string' },
      { name: '_resolutionTime', type: 'uint256' },
      { name: '_oracle', type: 'address' },
      { name: '_yesPrice', type: 'uint256' },
      { name: '_noPrice', type: 'uint256' },
      { name: '_yesShares', type: 'uint256' },
      { name: '_noShares', type: 'uint256' },
      { name: '_totalCollateral', type: 'uint256' },
      { name: '_resolved', type: 'bool' },
      { name: '_yesWins', type: 'bool' },
    ],
    stateMutability: 'view',
  },
  {
    name: 'getCost',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'shares', type: 'uint256' },
    ],
    outputs: [{ name: 'cost', type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getPayoutForSell',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'shares', type: 'uint256' },
    ],
    outputs: [{ name: 'payout', type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getYesPrice',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getNoPrice',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'yesToken',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'address' }],
    stateMutability: 'view',
  },
  {
    name: 'noToken',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'address' }],
    stateMutability: 'view',
  },
  {
    name: 'question',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'string' }],
    stateMutability: 'view',
  },
  {
    name: 'b',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'resolved',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'bool' }],
    stateMutability: 'view',
  },
  // Write functions
  {
    name: 'buy',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'minShares', type: 'uint256' },
    ],
    outputs: [],
    stateMutability: 'payable',
  },
  {
    name: 'sell',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'shares', type: 'uint256' },
      { name: 'minPayout', type: 'uint256' },
    ],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'resolve',
    type: 'function',
    inputs: [{ name: '_yesWins', type: 'bool' }],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'redeem',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'addLiquidity',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'payable',
  },
  // Events
  {
    name: 'SharesPurchased',
    type: 'event',
    inputs: [
      { name: 'buyer', type: 'address', indexed: true },
      { name: 'isYes', type: 'bool', indexed: false },
      { name: 'shares', type: 'uint256', indexed: false },
      { name: 'cost', type: 'uint256', indexed: false },
    ],
  },
  {
    name: 'SharesSold',
    type: 'event',
    inputs: [
      { name: 'seller', type: 'address', indexed: true },
      { name: 'isYes', type: 'bool', indexed: false },
      { name: 'shares', type: 'uint256', indexed: false },
      { name: 'payout', type: 'uint256', indexed: false },
    ],
  },
  {
    name: 'Redeemed',
    type: 'event',
    inputs: [
      { name: 'user', type: 'address', indexed: true },
      { name: 'shares', type: 'uint256', indexed: false },
      { name: 'payout', type: 'uint256', indexed: false },
    ],
  },
] as const;

// Legacy LMSR bytecode (compiled from contracts/LMSR.sol) - FIXED _ln function
const LMSR_BYTECODE = '0x60e060405234801562000010575f80fd5b5060405162002d2c38038062002d2c8339810160408190526200003391620002ab565b33806200005957604051631e4fbdf760e01b81525f600482015260240160405180910390fd5b62000064816200016c565b5060017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055600162000097898262000432565b506002879055600380546001600160a01b0319166001600160a01b03881617905560c0859052604051849084906012905f903090620000d690620001bb565b620000e69594939291906200052b565b604051809103905ff08015801562000100573d5f803e3d5ffd5b506001600160a01b0316608052604051829082906012905f9030906200012690620001bb565b620001369594939291906200052b565b604051809103905ff08015801562000150573d5f803e3d5ffd5b506001600160a01b031660a052506200057d9650505050505050565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b610ea58062001e8783390190565b634e487b7160e01b5f52604160045260245ffd5b5f5b83811015620001f9578181015183820152602001620001df565b50505f910152565b5f82601f83011262000211575f80fd5b81516001600160401b03808211156200022e576200022e620001c9565b604051601f8301601f19908116603f01168101908282118183101715620002595762000259620001c9565b8160405283815286602085880101111562000272575f80fd5b62000285846020830160208901620001dd565b9695505050505050565b80516001600160a01b0381168114620002a6575f80fd5b919050565b5f805f805f805f80610100898b031215620002c4575f80fd5b88516001600160401b0380821115620002db575f80fd5b620002e98c838d0162000201565b995060208b015198506200030060408c016200028f565b975060608b0151965060808b01519150808211156200031d575f80fd5b6200032b8c838d0162000201565b955060a08b015191508082111562000341575f80fd5b6200034f8c838d0162000201565b945060c08b015191508082111562000365575f80fd5b620003738c838d0162000201565b935060e08b015191508082111562000389575f80fd5b50620003988b828c0162000201565b9150509295985092959890939650565b600181811c90821680620003bd57607f821691505b602082108103620003dc57634e487b7160e01b5f52602260045260245ffd5b50919050565b601f8211156200042d57805f5260205f20601f840160051c81016020851015620004095750805b601f840160051c820191505b818110156200042a575f815560010162000415565b50505b505050565b81516001600160401b038111156200044e576200044e620001c9565b62000466816200045f8454620003a8565b84620003e2565b602080601f8311600181146200049c575f8415620004845750858301515b5f19600386901b1c1916600185901b178555620004f6565b5f85815260208120601f198616915b82811015620004cc57888601518255948401946001909101908401620004ab565b5085821015620004ea57878501515f19600388901b60f8161c191681555b505060018460011b0185555b505050505050565b5f815180845262000517816020860160208601620001dd565b601f01601f19169290920160200192915050565b60a081525f6200053f60a0830188620004fe565b8281036020840152620005538188620004fe565b60ff969096166040840152505060608101929092526001600160a01b031660809091015292915050565b60805160a05160c051611892620005f55f395f818161034a015281816105060152818161054e015281816105a90152818161089601526108d301525f818161023801528181610a7701528181610e72015261112201525f81816104a901528181610a9d01528181610dc1015261108c01526118925ff3fe60806040526004361061017e575f3560e01c80637dc0d1d0116100cd578063be040fb011610087578063e8078d9411610062578063e8078d9414610490578063f0d9bb2014610498578063f2fde38b146104cb578063f3e41e90146104ea575f80fd5b8063be040fb01461044a578063de2546591461045e578063e24c469b1461047d575f80fd5b80637dc0d1d01461039f5780638779086f146103be5780638da5cb5b146103d25780639860f1a7146103ee578063a4d750651461040d578063b44f77c11461042c575f80fd5b806327c7ff61116101385780634ac8eb5f116101135780634ac8eb5f146103245780634df7e3d014610339578063715018a61461036c5780637adbf97314610380575f80fd5b806327c7ff61146102c55780633f6fa655146102da5780633fad9ae014610303575f80fd5b806309604403146101d45780630bede3f81461020657806311a9f10a1461022757806312b01b161461027257806316953f021461028657806323341a051461029b575f80fd5b366101d0573460075f82825461019491906115d2565b909155505060405134815233907fc17cea59c2955cb181b03393209566960365771dbba9dc3d510180e7cb3120889060200160405180910390a2005b5f80fd5b3480156101df575f80fd5b506101f36101ee3660046115e5565b6104ff565b6040519081526020015b60405180910390f35b348015610211575f80fd5b50610225610220366004611612565b6105e4565b005b348015610232575f80fd5b5061025a7f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b0390911681526020016101fd565b34801561027d575f80fd5b506101f36106ad565b348015610291575f80fd5b506101f360045481565b3480156102a6575f80fd5b506102af6106cd565b6040516101fd9a99989796959493929190611677565b3480156102d0575f80fd5b506101f360055481565b3480156102e5575f80fd5b506006546102f39060ff1681565b60405190151581526020016101fd565b34801561030e575f80fd5b506103176107c6565b6040516101fd91906116dd565b34801561032f575f80fd5b506101f360075481565b348015610344575f80fd5b506101f37f000000000000000000000000000000000000000000000000000000000000000081565b348015610377575f80fd5b50610225610852565b34801561038b575f80fd5b5061022561039a3660046116ef565b610865565b3480156103aa575f80fd5b5060035461025a906001600160a01b031681565b3480156103c9575f80fd5b506101f361088f565b3480156103dd575f80fd5b505f546001600160a01b031661025a565b3480156103f9575f80fd5b506101f3610408366004611715565b610937565b348015610418575f80fd5b506101f3610427366004611715565b6109df565b348015610437575f80fd5b506006546102f390610100900460ff1681565b348015610455575f80fd5b50610225610a39565b348015610469575f80fd5b5061022561047836600461173f565b610d10565b61022561048b366004611715565b610fda565b6102256111f7565b3480156104a3575f80fd5b5061025a7f000000000000000000000000000000000000000000000000000000000000000081565b3480156104d6575f80fd5b506102256104e53660046116ef565b611264565b3480156104f5575f80fd5b506101f360025481565b5f806105467f000000000000000000000000000000000000000000000000000000000000000061053786670de0b6b3a7640000611771565b6105419190611788565b6112a6565b90505f61057f7f000000000000000000000000000000000000000000000000000000000000000061053786670de0b6b3a7640000611771565b90505f61058c82846115d2565b90505f6105988261132f565b9050670de0b6b3a76400006105cd827f0000000000000000000000000000000000000000000000000000000000000000611771565b6105d79190611788565b9450505050505b92915050565b6003546001600160a01b0316331461060f57604051631bc2178f60e01b815260040160405180910390fd5b60065460ff16156106335760405163aa43cb2d60e01b815260040160405180910390fd5b60025442101561065657604051633c04f06b60e01b815260040160405180910390fd5b600680548215156101000261ffff199091161760011790556040517ff528f3b02f5c2503827fc677c9d0cb54ffbf11ed32cb659f73243b70dea7cf0e906106a290831515815260200190565b60405180910390a150565b5f6106b661088f565b6106c890670de0b6b3a76400006117a7565b905090565b60605f805f805f805f805f600160025460035f9054906101000a90046001600160a01b03166106fa61088f565b6107026106ad565b600454600554600754600654885460ff80831692610100900416908a90610728906117ba565b80601f0160208091040260200160405190810160405280929190818152602001828054610754906117ba565b801561079f5780601f106107765761010080835404028352916020019161079f565b820191905f5260205f20905b81548152906001019060200180831161078257829003601f168201915b50505050509950995099509950995099509950995099509950995090919293949596979899565b600180546107d3906117ba565b80601f01602080910402602001604051908101604052809291908181526020018280546107ff906117ba565b801561084a5780601f106108215761010080835404028352916020019161084a565b820191905f5260205f20905b81548152906001019060200180831161082d57829003601f168201915b505050505081565b61085a61147a565b6108635f6114a6565b565b61086d61147a565b600380546001600160a01b0319166001600160a01b0392909216919091179055565b5f806108cb7f0000000000000000000000000000000000000000000000000000000000000000600454670de0b6b3a76400006105379190611771565b90505f6109087f0000000000000000000000000000000000000000000000000000000000000000600554670de0b6b3a76400006105379190611771565b905061091481836115d2565b61092683670de0b6b3a7640000611771565b6109309190611788565b9250505090565b5f828015610946575060045482115b1561095257505f6105de565b82158015610961575060055482115b1561096d57505f6105de565b5f8361097b57600454610989565b8260045461098991906117a7565b90505f846109a4578360055461099f91906117a7565b6109a8565b6005545b90505f6109b96004546005546104ff565b90505f6109c684846104ff565b90508082116109d5575f6105d7565b6105d781836117a7565b5f80836109ee576004546109fc565b826004546109fc91906115d2565b90505f84610a175783600554610a1291906115d2565b610a1b565b6005545b90505f610a2883836104ff565b90505f6109c66004546005546104ff565b610a416114f5565b60065460ff16610a645760405163174b639360e11b815260040160405180910390fd5b6006545f90610100900460ff16610a9b577f0000000000000000000000000000000000000000000000000000000000000000610abd565b7f00000000000000000000000000000000000000000000000000000000000000005b6040516370a0823160e01b81523360048201529091505f906001600160a01b038316906370a0823190602401602060405180830381865afa158015610b04573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610b2891906117f2565b9050805f03610b4a5760405163162908e360e11b815260040160405180910390fd5b6040516323b872dd60e01b8152336004820152306024820152604481018290526001600160a01b038316906323b872dd906064016020604051808303815f875af1158015610b9a573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610bbe9190611809565b506006545f90610100900460ff16610bd857600554610bdc565b6004545b90505f8160075484610bee9190611771565b610bf89190611788565b600654909150610100900460ff1615610c27578260045f828254610c1c91906117a7565b90915550610c3e9050565b8260055f828254610c3891906117a7565b90915550505b8060075f828254610c4f91906117a7565b90915550506040515f90339083908381818185875af1925050503d805f8114610c93576040519150601f19603f3d011682016040523d82523d5f602084013e610c98565b606091505b5050905080610cba576040516312171d8360e31b815260040160405180910390fd5b604080518581526020810184905233917ff3a670cd3af7d64b488926880889d08a8585a138ff455227af6737339a1ec262910160405180910390a2505050505061086360015f8051602061183d83398151915255565b610d186114f5565b60065460ff1615610d3c5760405163aa43cb2d60e01b815260040160405180910390fd5b815f03610d5c5760405163162908e360e11b815260040160405180910390fd5b5f610d678484610937565b905081811015610d8a5760405163cd1c886760e01b815260040160405180910390fd5b600754811115610d9957506007545b8315610e50576040516323b872dd60e01b8152336004820152306024820152604481018490527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906323b872dd906064016020604051808303815f875af1158015610e0f573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610e339190611809565b508260045f828254610e4591906117a7565b90915550610efc9050565b6040516323b872dd60e01b8152336004820152306024820152604481018490527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906323b872dd906064016020604051808303815f875af1158015610ec0573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610ee49190611809565b508260055f828254610ef691906117a7565b90915550505b8060075f828254610f0d91906117a7565b90915550506040515f90339083908381818185875af1925050503d805f8114610f51576040519150601f19603f3d011682016040523d82523d5f602084013e610f56565b606091505b5050905080610f78576040516312171d8360e31b815260040160405180910390fd5b6040805186151581526020810186905290810183905233907fcf06b88583ec57d4cf2f6795931fe9057d95a86052efc8d8b3a4cad0e885d5e99060600160405180910390a25050610fd560015f8051602061183d83398151915255565b505050565b610fe26114f5565b60065460ff16156110065760405163aa43cb2d60e01b815260040160405180910390fd5b345f036110265760405163cd1c886760e01b815260040160405180910390fd5b5f6110318334611510565b9050818110156110545760405163cd1c886760e01b815260040160405180910390fd5b82156110f0578060045f82825461106b91906115d2565b90915550506040516340c10f1960e01b8152336004820152602481018290527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906340c10f19906044015f604051808303815f87803b1580156110d5575f80fd5b505af11580156110e7573d5f803e3d5ffd5b50505050611182565b8060055f82825461110191906115d2565b90915550506040516340c10f1960e01b8152336004820152602481018290527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906340c10f19906044015f604051808303815f87803b15801561116b575f80fd5b505af115801561117d573d5f803e3d5ffd5b505050505b3460075f82825461119391906115d2565b9091555050604080518415158152602081018390523481830152905133917f9bd054fb950acb82b978a4ba93668286e2c3fa8c43589f21061c8520068ba80c919081900360600190a2506111f360015f8051602061183d83398151915255565b5050565b345f036112175760405163162908e360e11b815260040160405180910390fd5b3460075f82825461122891906115d2565b909155505060405134815233907fc17cea59c2955cb181b03393209566960365771dbba9dc3d510180e7cb3120889060200160405180910390a2565b61126c61147a565b6001600160a01b03811661129a57604051631e4fbdf760e01b81525f60048201526024015b60405180910390fd5b6112a3816114a6565b50565b5f6753444835ec5800008211156112c3576753444835ec58000091505b670de0b6b3a76400008060015b600c8111611326576112ea81670de0b6b3a7640000611771565b6112f48684611771565b6112fe9190611788565b915061130a82846115d2565b925060018210611326578061131e81611824565b9150506112d0565b50909392505050565b5f670de0b6b3a764000082101561134757505f919050565b81670de0b6b3a76400000361135d57505f919050565b67099e8db03256ce5d5f5b671bc16d674ec80000841061139657611382600285611788565b93508061138e81611824565b915050611368565b5f6113a9670de0b6b3a7640000866117a7565b9050805f036113c5576113bc8383611771565b95945050505050565b5f816001805b601e81116114595781156113f4576113e38184611788565b6113ed90856115d2565b935061141b565b836113ff8285611788565b116114595761140e8184611788565b61141890856117a7565b93505b670de0b6b3a764000061142e8685611771565b6114389190611788565b9250901590620f42408310611459578061145181611824565b9150506113cb565b506114648686611771565b61146e90846115d2565b98975050505050505050565b5f546001600160a01b031633146108635760405163118cdaa760e01b8152336004820152602401611291565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b6114fd61158f565b60025f8051602061183d83398151915255565b5f808061151e846002611771565b90505f805b604081101561158457600261153884866115d2565b6115429190611788565b91505f61154f88846109df565b905086811161156057829450611564565b8293505b600161157086866117a7565b1161157b5750611584565b50600101611523565b509195945050505050565b5f8051602061183d8339815191525460020361086357604051633ee5aeb560e01b815260040160405180910390fd5b634e487b7160e01b5f52601160045260245ffd5b808201808211156105de576105de6115be565b5f80604083850312156115f6575f80fd5b50508035926020909101359150565b80151581146112a3575f80fd5b5f60208284031215611622575f80fd5b813561162d81611605565b9392505050565b5f81518084525f5b818110156116585760208185018101518683018201520161163c565b505f602082860101526020601f19601f83011685010191505092915050565b5f61014080835261168a8184018e611634565b602084019c909c5250506001600160a01b039890981660408901526060880196909652608087019490945260a086019290925260c085015260e08401521515610100830152151561012090910152919050565b602081525f61162d6020830184611634565b5f602082840312156116ff575f80fd5b81356001600160a01b038116811461162d575f80fd5b5f8060408385031215611726575f80fd5b823561173181611605565b946020939093013593505050565b5f805f60608486031215611751575f80fd5b833561175c81611605565b95602085013595506040909401359392505050565b80820281158282048414176105de576105de6115be565b5f826117a257634e487b7160e01b5f52601260045260245ffd5b500490565b818103818111156105de576105de6115be565b600181811c908216806117ce57607f821691505b6020821081036117ec57634e487b7160e01b5f52602260045260245ffd5b50919050565b5f60208284031215611802575f80fd5b5051919050565b5f60208284031215611819575f80fd5b815161162d81611605565b5f60018201611835576118356115be565b506001019056fe9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f00a26469706673582212200b71eb8b70d23f713fd44ce3892cc58f1def09a2287203da44238c035716fa8e64736f6c6343000818003360a060405234801562000010575f80fd5b5060405162000ea538038062000ea583398101604081905262000033916200032c565b80858560036200004483826200045e565b5060046200005382826200045e565b5050506001600160a01b0381166200008557604051631e4fbdf760e01b81525f60048201526024015b60405180910390fd5b6200009081620000af565b5060ff8316608052620000a4818362000100565b505050505062000550565b600580546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0905f90a35050565b6001600160a01b0382166200012b5760405163ec442f0560e01b81525f60048201526024016200007c565b620001385f83836200013c565b5050565b6001600160a01b0383166200016a578060025f8282546200015e91906200052a565b90915550620001dc9050565b6001600160a01b0383165f9081526020819052604090205481811015620001be5760405163391434e360e21b81526001600160a01b038516600482015260248101829052604481018390526064016200007c565b6001600160a01b0384165f9081526020819052604090209082900390555b6001600160a01b038216620001fa5760028054829003905562000218565b6001600160a01b0382165f9081526020819052604090208054820190555b816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516200025e91815260200190565b60405180910390a3505050565b634e487b7160e01b5f52604160045260245ffd5b5f82601f8301126200028f575f80fd5b81516001600160401b0380821115620002ac57620002ac6200026b565b604051601f8301601f19908116603f01168101908282118183101715620002d757620002d76200026b565b8160405283815260209250866020858801011115620002f4575f80fd5b5f91505b83821015620003175785820183015181830184015290820190620002f8565b5f602085830101528094505050505092915050565b5f805f805f60a0868803121562000341575f80fd5b85516001600160401b038082111562000358575f80fd5b6200036689838a016200027f565b965060208801519150808211156200037c575f80fd5b506200038b888289016200027f565b945050604086015160ff81168114620003a2575f80fd5b6060870151608088015191945092506001600160a01b0381168114620003c6575f80fd5b809150509295509295909350565b600181811c90821680620003e957607f821691505b6020821081036200040857634e487b7160e01b5f52602260045260245ffd5b50919050565b601f8211156200045957805f5260205f20601f840160051c81016020851015620004355750805b601f840160051c820191505b8181101562000456575f815560010162000441565b50505b505050565b81516001600160401b038111156200047a576200047a6200026b565b62000492816200048b8454620003d4565b846200040e565b602080601f831160018114620004c8575f8415620004b05750858301515b5f19600386901b1c1916600185901b17855562000522565b5f85815260208120601f198616915b82811015620004f857888601518255948401946001909101908401620004d7565b50858210156200051657878501515f19600388901b60f8161c191681555b505060018460011b0185555b505050505050565b808201808211156200054a57634e487b7160e01b5f52601160045260245ffd5b92915050565b60805161093c620005695f395f610156015261093c5ff3fe608060405234801561000f575f80fd5b50600436106100e5575f3560e01c806370a082311161008857806395d89b411161006357806395d89b41146101f3578063a9059cbb146101fb578063dd62ed3e1461020e578063f2fde38b14610246575f80fd5b806370a08231146101a8578063715018a6146101d05780638da5cb5b146101d8575f80fd5b806323b872dd116100c357806323b872dd1461013c578063313ce5671461014f57806340c10f191461018057806342966c6814610195575f80fd5b806306fdde03146100e9578063095ea7b31461010757806318160ddd1461012a575b5f80fd5b6100f1610259565b6040516100fe919061077f565b60405180910390f35b61011a6101153660046107e6565b6102e9565b60405190151581526020016100fe565b6002545b6040519081526020016100fe565b61011a61014a36600461080e565b610302565b60405160ff7f00000000000000000000000000000000000000000000000000000000000000001681526020016100fe565b61019361018e3660046107e6565b610325565b005b6101936101a3366004610847565b61033b565b61012e6101b636600461085e565b6001600160a01b03165f9081526020819052604090205490565b610193610348565b6005546040516001600160a01b0390911681526020016100fe565b6100f161035b565b61011a6102093660046107e6565b61036a565b61012e61021c36600461087e565b6001600160a01b039182165f90815260016020908152604080832093909416825291909152205490565b61019361025436600461085e565b610377565b606060038054610268906108af565b80601f0160208091040260200160405190810160405280929190818152602001828054610294906108af565b80156102df5780601f106102b6576101008083540402835291602001916102df565b820191905f5260205f20905b8154815290600101906020018083116102c257829003601f168201915b5050505050905090565b5f336102f68185856103b6565b60019150505b92915050565b5f3361030f8582856103c8565b61031a858585610444565b506001949350505050565b61032d6104a1565b61033782826104ce565b5050565b6103453382610502565b50565b6103506104a1565b6103595f610536565b565b606060048054610268906108af565b5f336102f6818585610444565b61037f6104a1565b6001600160a01b0381166103ad57604051631e4fbdf760e01b81525f60048201526024015b60405180910390fd5b61034581610536565b6103c38383836001610587565b505050565b6001600160a01b038381165f908152600160209081526040808320938616835292905220545f1981101561043e578181101561043057604051637dc7a0d960e11b81526001600160a01b038416600482015260248101829052604481018390526064016103a4565b61043e84848484035f610587565b50505050565b6001600160a01b03831661046d57604051634b637e8f60e11b81525f60048201526024016103a4565b6001600160a01b0382166104965760405163ec442f0560e01b81525f60048201526024016103a4565b6103c3838383610659565b6005546001600160a01b031633146103595760405163118cdaa760e01b81523360048201526024016103a4565b6001600160a01b0382166104f75760405163ec442f0560e01b81525f60048201526024016103a4565b6103375f8383610659565b6001600160a01b03821661052b57604051634b637e8f60e11b81525f60048201526024016103a4565b610337825f83610659565b600580546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0905f90a35050565b6001600160a01b0384166105b05760405163e602df0560e01b81525f60048201526024016103a4565b6001600160a01b0383166105d957604051634a1406b160e11b81525f60048201526024016103a4565b6001600160a01b038085165f908152600160209081526040808320938716835292905220829055801561043e57826001600160a01b0316846001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9258460405161064b91815260200190565b60405180910390a350505050565b6001600160a01b038316610683578060025f82825461067891906108e7565b909155506106f39050565b6001600160a01b0383165f90815260208190526040902054818110156106d55760405163391434e360e21b81526001600160a01b038516600482015260248101829052604481018390526064016103a4565b6001600160a01b0384165f9081526020819052604090209082900390555b6001600160a01b03821661070f5760028054829003905561072d565b6001600160a01b0382165f9081526020819052604090208054820190555b816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8360405161077291815260200190565b60405180910390a3505050565b5f602080835283518060208501525f5b818110156107ab5785810183015185820160400152820161078f565b505f604082860101526040601f19601f8301168501019250505092915050565b80356001600160a01b03811681146107e1575f80fd5b919050565b5f80604083850312156107f7575f80fd5b610800836107cb565b946020939093013593505050565b5f805f60608486031215610820575f80fd5b610829846107cb565b9250610837602085016107cb565b9150604084013590509250925092565b5f60208284031215610857575f80fd5b5035919050565b5f6020828403121561086e575f80fd5b610877826107cb565b9392505050565b5f806040838503121561088f575f80fd5b610898836107cb565b91506108a6602084016107cb565b90509250929050565b600181811c908216806108c357607f821691505b6020821081036108e157634e487b7160e01b5f52602260045260245ffd5b50919050565b808201808211156102fc57634e487b7160e01b5f52601160045260245ffdfea264697066735822122016c9be8f982c06a57ff825f2ca65cbb1a39fd2f8a690f9ee0cceda68219e85df64736f6c63430008180033' as const;

// LS-LMSR bytecode (compiled from contracts/LSLMSR.sol with Solidity 0.8.28, EVM prague)
// Protocol fees auto-transfer to 0x048c2c9E869594a70c6Dc7CeAC168E724425cdFE on every trade
const LSLMSR_BYTECODE = '0x6101206040526132ae8038038061001581610485565b9283398101610160828203126104815781516001600160401b03811161048157816100419184016104aa565b602083015160408401516001600160a01b03811694919085900361048157606082015193608083015160a08401519560c08501519760e086015160018060401b03811161048157846100949188016104aa565b6101008701519095906001600160401b03811161048157856100b79189016104aa565b6101208801519097906001600160401b03811161048157866100da9183016104aa565b6101408201519096906001600160401b038111610481576100fb92016104aa565b97331561046e575f8054336001600160a01b0319821681178355916001600160a01b03909116907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09080a360017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055831561045757428211156104575782156104575789158015610466575b61045757670de0b6b3a76400003410610448578051906001600160401b0382116103375760015490600182811c9216801561043e575b602083101461042a5781601f8493116103bc575b50602090601f8311600114610356575f9261034b575b50508160011b915f199060031b1c1916176001555b600255600380546001600160a01b03191691909117905560c05260e052336101005234600a819055600755604051610d4e93848201906001600160401b03821183831017610337578291610259916125609688888639309261051f565b03905ff0801561032c5760805260405193838501916001600160401b0383118684101761033757859461028f948639309261051f565b03905ff0801561032c5760a052600455600555604051611ff990816105678239608051818181610311015281816104ba0152818161080e0152610c0b015260a0518181816105f90152818161096b01528181610e130152611582015260c051818181610aea015261187b015260e0518181816113eb015281816118a30152611a570152610100518181816110e5015281816112c301526113880152f35b6040513d5f823e3d90fd5b634e487b7160e01b5f52604160045260245ffd5b015190505f806101e7565b60015f9081528281209350601f198516905b8181106103a4575090846001959493921061038c575b505050811b016001556101fc565b01515f1960f88460031b161c191690555f808061037e565b92936020600181928786015181550195019301610368565b60015f529091507fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6601f840160051c81019160208510610420575b90601f859493920160051c01905b81811061041257506101d1565b5f8155849350600101610405565b90915081906103f7565b634e487b7160e01b5f52602260045260245ffd5b91607f16916101bd565b6339372c1f60e11b5f5260045ffd5b630e52390960e41b5f5260045ffd5b508a15610187565b631e4fbdf760e01b5f525f60045260245ffd5b5f80fd5b6040519190601f01601f191682016001600160401b0381118382101761033757604052565b81601f82011215610481578051906001600160401b038211610337576104d9601f8301601f1916602001610485565b928284526020838301011161048157815f9260208093018386015e8301015290565b805180835260209291819084018484015e5f828201840152601f01601f1916010190565b916105499061053b60809396959660a0865260a08601906104fb565b9084820360208601526104fb565b601260408401525f60608401526001600160a01b0390941691015256fe6080806040526004361015610057575b50361561001a575f80fd5b61002634600754611810565b6007556040513481527fc17cea59c2955cb181b03393209566960365771dbba9dc3d510180e7cb31208860203392a2005b5f905f3560e01c90816202eab7146116a25750806309604403146116815780630bede3f8146115ce5780630f528235146115b157806311a9f10a1461156d57806312b01b161461155357806315d7ff411461153657806316953f021461151957806321ae7307146114fc57806323341a051461140e578063252cf2d2146113d457806327c7ff61146113b757806327cbaabe14611373578063351fee46146112a95780633a69a1be1461128f5780633f4ba83a146112235780633f6fa655146112015780633fad9ae0146111ce5780634ac8eb5f146111b157806350695cee146110cb5780635c975abb146110a75780635dafcd591461108d578063715018a614611036578063730143c6146110085780637adbf97314610f825780637dc0d1d014610f5a5780638456cb5914610efa5780638779086f14610ee05780638da5cb5b14610eb95780639860f1a714610e92578063a4d7506514610e6b578063b44f77c114610e46578063be040fb014610bd9578063c92841ca14610b79578063ccb26f0f14610b5e578063cdd4214814610b2a578063d73792a914610b0d578063db1d0fd514610ad2578063dd4d7bf714610ab6578063de254659146106de578063e24c469b1461039f578063e8078d9414610340578063f0d9bb20146102fb578063f2fde38b1461026d5763f3e41e900361000f573461026a578060031936011261026a576020600254604051908152f35b80fd5b503461026a57602036600319011261026a576004356001600160a01b038116908190036102f75761029c611ecd565b80156102e35781546001600160a01b03198116821783556001600160a01b03167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08380a380f35b631e4fbdf760e01b82526004829052602482fd5b5080fd5b503461026a578060031936011261026a576040517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b508060031936011261026a5734156103905761035e34600754611810565b6007556040513481527fc17cea59c2955cb181b03393209566960365771dbba9dc3d510180e7cb31208860203392a280f35b63162908e360e11b8152600490fd5b50604036600319011261026a576103b46116c5565b6103bc611e95565b6103c4611f86565b60ff600654166106cf5734156106c057606434023481046064036106ac5761271090047f77f1347be3de8572acbf9c89d2477397b4410a469b1e32dee5b9f8e2d4f1adbe6104128234611b5e565b918060011c9061047b6104258383611b5e565b878080808773048c2c9e869594a70c6dc7ceac168e724425cdfe5af16104496119fa565b50610698575b61045b81600854611810565b600855604051938493846040919493926060820195825260208201520152565b0390a16104888183611ef3565b602435811061068957801561067a57836104a28285611c16565b9284156105e8576104b583600454611810565b6004557f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316803b156105e4576040516340c10f1960e01b8152336004820152602481018590529083908290604490829084905af19081156105d95783916105c4575b50505b61052e84600754611810565b600755838111610590575b5050604080519315158452602084019190915282015233907f9bd054fb950acb82b978a4ba93668286e2c3fa8c43589f21061c8520068ba80c9080606081015b0390a260015f516020611fa45f395f51905f525580f35b818061059d868294611b5e565b335af16105a86119fa565b50156105b557835f610539565b6312171d8360e31b8452600484fd5b816105ce916116f8565b6102f757815f61051f565b6040513d85823e3d90fd5b8280fd5b6105f483600554611810565b6005557f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316803b156105e4576040516340c10f1960e01b8152336004820152602481018590529083908290604490829084905af19081156105d9578391610665575b5050610522565b8161066f916116f8565b6102f757815f61065e565b63162908e360e11b8452600484fd5b63cd1c886760e01b8452600484fd5b6106a484600954611810565b60095561044f565b634e487b7160e01b83526011600452602483fd5b63cd1c886760e01b8252600482fd5b63aa43cb2d60e01b8252600482fd5b503461026a57606036600319011261026a576106f86116c5565b602435610703611e95565b61070b611f86565b60ff60065416610aa7578015610a98578115610a6c57600454670de0b6b3a763ffff198101908111610a58578111610a49575b6107488183611b6b565b90600754808311610a41575b506064820282810460641483151715610a2d576127109004916107778382611b5e565b926044358410610a1e57807f77f1347be3de8572acbf9c89d2477397b4410a469b1e32dee5b9f8e2d4f1adbe9160011c906107d96107b58383611b5e565b898080808773048c2c9e869594a70c6dc7ceac168e724425cdfe5af16104496119fa565b0390a1831561093f576040516323b872dd60e01b81523360048201523060248201526044810183905285906001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000169060208160648186865af180156105d957610912575b50803b156102f757818091602460405180948193630852cd8d60e31b83528960048401525af18015610907576108ee575b50506108939061088783600454611b5e565b6004555b600754611b5e565b6007558380808085335af16108a66119fa565b50156105b557604080519315158452602084019190915282015233907fcf06b88583ec57d4cf2f6795931fe9057d95a86052efc8d8b3a4cad0e885d5e9908060608101610579565b816108f8916116f8565b61090357845f610875565b8480fd5b6040513d84823e3d90fd5b6109339060203d602011610938575b61092b81836116f8565b810190611c67565b610844565b503d610921565b6040516323b872dd60e01b81523360048201523060248201526044810183905285906001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000169060208160648186865af180156105d957610a01575b50803b156102f757818091602460405180948193630852cd8d60e31b83528960048401525af18015610907576109ec575b5050610893906109e483600554611b5e565b60055561088b565b816109f6916116f8565b61090357845f6109d2565b610a199060203d6020116109385761092b81836116f8565b6109a1565b63cd1c886760e01b8652600486fd5b634e487b7160e01b85526011600452602485fd5b91505f610754565b633999656760e01b8352600483fd5b634e487b7160e01b84526011600452602484fd5b600554670de0b6b3a763ffff198101908111610a585781111561073e57633999656760e01b8352600483fd5b63162908e360e11b8352600483fd5b63aa43cb2d60e01b8352600483fd5b503461026a578060031936011261026a57602060405160648152f35b503461026a578060031936011261026a5760206040517f00000000000000000000000000000000000000000000000000000000000000008152f35b503461026a578060031936011261026a5760206040516127108152f35b503461026a578060031936011261026a576020610b56610b48611ac4565b610b50611957565b90611810565b604051908152f35b503461026a578060031936011261026a576020610b56611c7f565b503461026a57604036600319011261026a57610b936116c5565b9060243590606482029082820460641483151715610bc5576020610b5685610bbf612710860487611b5e565b90611ef3565b634e487b7160e01b81526011600452602490fd5b5034610dad575f366003190112610dad57610bf2611e95565b60065460ff811615610e375760081c60ff1615610e11577f00000000000000000000000000000000000000000000000000000000000000005b6040516370a0823160e01b8152336004820152906001600160a01b0316602082602481845afa918215610da2575f92610ddd575b508115610dce576040516323b872dd60e01b8152336004820152306024820152604481018390526020816064815f865af18015610da257610db1575b50803b15610dad575f8091602460405180948193630852cd8d60e31b83528760048401525af18015610da257610d8d575b5080600754808311610d85575b5060065460081c60ff1615610d7157610cf482600454611b5e565b6004555b610d0481600754611b5e565b6007558280808084335af1610d176119fa565b5015610d625760405191825260208201527ff3a670cd3af7d64b488926880889d08a8585a138ff455227af6737339a1ec26260403392a260015f516020611fa45f395f51905f525580f35b6312171d8360e31b8352600483fd5b610d7d82600554611b5e565b600555610cf8565b90505f610cd9565b610d9a9192505f906116f8565b5f905f610ccc565b6040513d5f823e3d90fd5b5f80fd5b610dc99060203d6020116109385761092b81836116f8565b610c9b565b63162908e360e11b5f5260045ffd5b9091506020813d602011610e09575b81610df9602093836116f8565b81010312610dad5751905f610c5f565b3d9150610dec565b7f0000000000000000000000000000000000000000000000000000000000000000610c2b565b63174b639360e11b5f5260045ffd5b34610dad575f366003190112610dad57602060ff60065460081c166040519015158152f35b34610dad576040366003190112610dad576020610b56610e896116c5565b60243590611c16565b34610dad576040366003190112610dad576020610b56610eb06116c5565b60243590611b6b565b34610dad575f366003190112610dad575f546040516001600160a01b039091168152602090f35b34610dad575f366003190112610dad576020610b56611ac4565b34610dad575f366003190112610dad57610f12611ecd565b610f1a611f86565b5f805460ff60a01b1916600160a01b1790556040513381527f62e78cea01bee320cd4e420270b5ea74000d11b0c9f74754ebdbfc544b05a25890602090a1005b34610dad575f366003190112610dad576003546040516001600160a01b039091168152602090f35b34610dad576020366003190112610dad576004356001600160a01b03811690819003610dad57610fb0611ecd565b8015610ff957600380546001600160a01b0319811683179091556001600160a01b03167f05cd89403c6bdeac21c2ff33de395121a31fa1bc2bf3adf4825f1f86e79969dd5f80a3005b630e52390960e41b5f5260045ffd5b34610dad575f366003190112610dad57602060405173048c2c9e869594a70c6dc7ceac168e724425cdfe8152f35b34610dad575f366003190112610dad5761104e611ecd565b5f80546001600160a01b0319811682556001600160a01b03167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08280a3005b34610dad575f366003190112610dad576020610b56611a87565b34610dad575f366003190112610dad57602060ff5f5460a01c166040519015158152f35b34610dad575f366003190112610dad576110e3611e95565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03811690338290036111a25760ff6006541615610e3757600754908115611193575f8080848194826007555af16111406119fa565b50156111845760207f3fccf14f0b7351b6ee572b02657fc342c474c736c4c0230b51a49bd111776ad991604051908152a260015f516020611fa45f395f51905f5255005b6312171d8360e31b5f5260045ffd5b63211b631760e21b5f5260045ffd5b6393687c0b60e01b5f5260045ffd5b34610dad575f366003190112610dad576020600754604051908152f35b34610dad575f366003190112610dad576111fd6111e961172e565b6040519182916020835260208301906116d4565b0390f35b34610dad575f366003190112610dad57602060ff600654166040519015158152f35b34610dad575f366003190112610dad5761123b611ecd565b5f5460ff8160a01c16156112805760ff60a01b19165f556040513381527f5db9ee0a495bf2e6ff9c91a7834c1ba4fdd244a5e8aa4e537bd38aeae4b073aa90602090a1005b638dfc202b60e01b5f5260045ffd5b34610dad575f366003190112610dad576020610b56611a39565b34610dad575f366003190112610dad576112c1611e95565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03811690338290036111a25760ff600654161580611368575b610e3757600854908115611193575f8080848194826008555af16113246119fa565b50156111845760207fd046302bdc39599e60a5981e59227dcd1c643f512f56f2e984390c3ac6eadedb91604051908152a260015f516020611fa45f395f51905f5255005b506002544210611302565b34610dad575f366003190112610dad576040517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b34610dad575f366003190112610dad576020600554604051908152f35b34610dad575f366003190112610dad5760206040517f00000000000000000000000000000000000000000000000000000000000000008152f35b34610dad575f366003190112610dad576002546003546001600160a01b031690611436611ac4565b61143e611957565b611446611a87565b61144e611c7f565b60045460055460075491611460611a39565b93611469611ac4565b611471611957565b61147a91611810565b956006549761148761172e565b996040519c8d9c8d9c8d6101c081526101c0016114a3916116d4565b9c6020015260408d015260608c015260808b015260a08a015260c089015260e088015261010087015261012086015261014085015261016084015260ff8116151561018084015260081c60ff1615156101a08301520390f35b34610dad575f366003190112610dad576020600854604051908152f35b34610dad575f366003190112610dad576020600454604051908152f35b34610dad575f366003190112610dad576020600a54604051908152f35b34610dad575f366003190112610dad576020610b56611957565b34610dad575f366003190112610dad576040517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b34610dad575f366003190112610dad576020600954604051908152f35b34610dad576020366003190112610dad576115e76116c5565b6003546001600160a01b03163303611672576006549060ff8216611663576002544210611654577ff528f3b02f5c2503827fc677c9d0cb54ffbf11ed32cb659f73243b70dea7cf0e91600160209215159161ff008360081b169061ffff19161717600655604051908152a1005b633c04f06b60e01b5f5260045ffd5b63aa43cb2d60e01b5f5260045ffd5b631bc2178f60e01b5f5260045ffd5b34610dad576040366003190112610dad576020610b56602435600435611862565b34610dad575f366003190112610dad576040906008546009549082526020820152f35b600435908115158203610dad57565b805180835260209291819084018484015e5f828201840152601f01601f1916010190565b90601f8019910116810190811067ffffffffffffffff82111761171a57604052565b634e487b7160e01b5f52604160045260245ffd5b604051905f6001548060011c9160018216918215611806575b6020841083146117f25783865285929081156117d35750600114611774575b611772925003836116f8565b565b5060015f90815290917fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf65b8183106117b757505090602061177292820101611766565b602091935080600191548385890101520191019091849261179f565b6020925061177294915060ff191682840152151560051b820101611766565b634e487b7160e01b5f52602260045260245ffd5b92607f1692611747565b9190820180921161181d57565b634e487b7160e01b5f52601160045260245ffd5b8181029291811591840414171561181d57565b811561184e570490565b634e487b7160e01b5f52601260045260245ffd5b90670de0b6b3a764000061189f6118798385611810565b7f0000000000000000000000000000000000000000000000000000000000000000611831565b04917f000000000000000000000000000000000000000000000000000000000000000080841061194f575b50670de0b6b3a7640000810290808204670de0b6b3a7640000149015171561181d576118f9836118fe92611844565b611cb1565b91670de0b6b3a7640000820291808304670de0b6b3a7640000149015171561181d57611945611940670de0b6b3a764000094610b506118f98561194b97611844565b611d4f565b90611831565b0490565b92505f6118ca565b61195f611a39565b600454670de0b6b3a7640000810290808204670de0b6b3a7640000149015171561181d576118f98261199092611844565b90600554670de0b6b3a7640000810290808204670de0b6b3a7640000149015171561181d576119c2916118f991611844565b90670de0b6b3a7640000820290828204670de0b6b3a7640000148315171561181d576119f7926119f191611810565b90611844565b90565b3d15611a34573d9067ffffffffffffffff821161171a5760405191611a29601f8201601f1916602001846116f8565b82523d5f602084013e565b606090565b670de0b6b3a7640000611a5461187960045460055490611810565b047f000000000000000000000000000000000000000000000000000000000000000080821115611a82575090565b905090565b611a8f611ac4565b611a9a610b48611ac4565b670de0b6b3a7640000820291808304670de0b6b3a7640000149015171561181d576119f791611844565b611acc611a39565b600454670de0b6b3a7640000810290808204670de0b6b3a7640000149015171561181d576118f982611afd92611844565b90600554670de0b6b3a7640000810290808204670de0b6b3a7640000149015171561181d57611b2f916118f991611844565b90670de0b6b3a7640000810290808204670de0b6b3a7640000148115171561181d576119f7926119f191611810565b9190820391821161181d57565b908180611c0b575b611bd857811580611c00575b611bd8578115611bf757611b9581600454611b5e565b915b15611be657506005545b81158015611bde575b611bd857611bc790611bc160045460055490611862565b92611862565b80821115611bd8576119f791611b5e565b50505f90565b508015611baa565b611bf290600554611b5e565b611ba1565b60045491611b97565b506005548111611b7f565b506004548111611b73565b611c3d918115611c5e57611c2c81600454611810565b915b15611c4c575060055490611862565b611bc760045460055490611862565b611c5890600554611810565b90611862565b60045491611c2e565b90816020910312610dad57518015158103610dad5790565b611c87611a87565b670de0b6b3a764000003670de0b6b3a7640000811161181d5790565b5f19811461181d5760010190565b6753444835ec5800008111611d40575b670de0b6b3a764000090600190825b600c831115611ce0575b50505090565b81611cea91611831565b670de0b6b3a7640000830290838204670de0b6b3a7640000148415171561181d57611d1f91611d1891611844565b8094611810565b9160018410611d3857611d3190611ca3565b9192611cd0565b829350611cda565b506753444835ec580000611cc1565b670de0b6b3a76400008110611e9057670de0b6b3a76400008114611e90575f5b671bc16d674ec80000821015611e7d57670de0b6b3a763ffff19820191821161181d578115611e60575f91806001805b601e811115611dd7575b5050505067099e8db03256ce5d81029080820467099e8db03256ce5d149015171561181d576119f791611810565b9091929483835f14611e2857611e0490611dfe670de0b6b3a764000093610b50868b611844565b97611831565b04911590620f42408310611e2357611e1b90611ca3565b929192611d9f565b611da9565b5080611e348388611844565b11611e5a57611e0484611dfe670de0b6b3a764000093611e54868b611844565b90611b5e565b94611da9565b67099e8db03256ce5d8082029250811591830414171561181d5790565b90611e8b9060011c91611ca3565b611d6f565b505f90565b60025f516020611fa45f395f51905f525414611ebe5760025f516020611fa45f395f51905f5255565b633ee5aeb560e01b5f5260045ffd5b5f546001600160a01b03163303611ee057565b63118cdaa760e01b5f523360045260245ffd5b5f91906001600160ff1b03821115611f6c57905f195b5f925b60408410611f1c575b5050505090565b90919293611f2a8382611810565b60011c9084611f398385611c16565b11611f635750935b6001611f4d8685611b5e565b1115611f5e57600101929190611f0c565b611f15565b94925091611f41565b8160011b8281046002148315171561181d57919091611f09565b60ff5f5460a01c16611f9457565b63d93c066560e01b5f5260045ffdfe9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f00a26469706673582212206475f558184c3e463574822e916c63009206c1b9fb90bc88660e6fbd8ed3187464736f6c634300081c003360a06040523461041d57610d4e8038038061001981610421565b928339810160a08282031261041d5781516001600160401b03811161041d5781610044918401610446565b602083015190916001600160401b03821161041d57610064918401610446565b91604081015160ff8116810361041d5760608201516080909201516001600160a01b038116939084900361041d578051906001600160401b0382116103205760035490600182811c92168015610413575b60208310146103025781601f8493116103a5575b50602090601f831160011461033f575f92610334575b50508160011b915f199060031b1c1916176003555b83516001600160401b03811161032057600454600181811c91168015610316575b602082101461030257601f811161029f575b50602094601f821160011461023c579481929394955f92610231575b50508160011b915f199060031b1c1916176004555b821561021e57600580546001600160a01b03198116851790915583906001600160a01b03167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e05f80a36080526002549080820180921161020a5760207fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef915f9360025584845283825260408420818154019055604051908152a36040516108b690816104988239608051816104fb0152f35b634e487b7160e01b5f52601160045260245ffd5b631e4fbdf760e01b5f525f60045260245ffd5b015190505f80610143565b601f1982169560045f52805f20915f5b8881106102875750836001959697981061026f575b505050811b01600455610158565b01515f1960f88460031b161c191690555f8080610261565b9192602060018192868501518155019401920161024c565b60045f527f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b601f830160051c810191602084106102f8575b601f0160051c01905b8181106102ed5750610127565b5f81556001016102e0565b90915081906102d7565b634e487b7160e01b5f52602260045260245ffd5b90607f1690610115565b634e487b7160e01b5f52604160045260245ffd5b015190505f806100df565b60035f9081528281209350601f198516905b81811061038d5750908460019594939210610375575b505050811b016003556100f4565b01515f1960f88460031b161c191690555f8080610367565b92936020600181928786015181550195019301610351565b60035f529091507fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b601f840160051c81019160208510610409575b90601f859493920160051c01905b8181106103fb57506100c9565b5f81558493506001016103ee565b90915081906103e0565b91607f16916100b5565b5f80fd5b6040519190601f01601f191682016001600160401b0381118382101761032057604052565b81601f8201121561041d578051906001600160401b03821161032057610475601f8301601f1916602001610421565b928284526020838301011161041d57815f9260208093018386015e830101529056fe6080806040526004361015610012575f80fd5b5f3560e01c90816306fdde031461069d57508063095ea7b31461061b57806318160ddd146105fe57806323b872dd1461051f578063313ce567146104e257806340c10f191461043657806342966c681461039657806370a082311461035f578063715018a6146103045780638da5cb5b146102dc57806395d89b41146101c1578063a9059cbb14610190578063dd62ed3e146101405763f2fde38b146100b6575f80fd5b3461013c57602036600319011261013c576100cf610796565b6100d7610859565b6001600160a01b0316801561012957600580546001600160a01b0319811683179091556001600160a01b03167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e05f80a3005b631e4fbdf760e01b5f525f60045260245ffd5b5f80fd5b3461013c57604036600319011261013c57610159610796565b6101616107ac565b6001600160a01b039182165f908152600160209081526040808320949093168252928352819020549051908152f35b3461013c57604036600319011261013c576101b66101ac610796565b60243590336107c2565b602060405160018152f35b3461013c575f36600319011261013c576040515f6004548060011c906001811680156102d2575b6020831081146102be578285529081156102a2575060011461024d575b50819003601f01601f191681019067ffffffffffffffff821181831017610239576102358291826040528261076c565b0390f35b634e487b7160e01b5f52604160045260245ffd5b905060045f527f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b5f905b82821061028c57506020915082010182610205565b6001816020925483858801015201910190610277565b90506020925060ff191682840152151560051b82010182610205565b634e487b7160e01b5f52602260045260245ffd5b91607f16916101e8565b3461013c575f36600319011261013c576005546040516001600160a01b039091168152602090f35b3461013c575f36600319011261013c5761031c610859565b600580546001600160a01b031981169091555f906001600160a01b03167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08280a3005b3461013c57602036600319011261013c576001600160a01b03610380610796565b165f525f602052602060405f2054604051908152f35b3461013c57602036600319011261013c57600435331561042357335f525f60205260405f205481811061040a5790805f923384528360205203604083205580600254036002556040519081527fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef60203392a3005b63391434e360e21b5f523360045260245260445260645ffd5b634b637e8f60e11b5f525f60045260245ffd5b3461013c57604036600319011261013c5761044f610796565b6024359061045b610859565b6001600160a01b03169081156104cf57600254908082018092116104bb5760207fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef915f9360025584845283825260408420818154019055604051908152a3005b634e487b7160e01b5f52601160045260245ffd5b63ec442f0560e01b5f525f60045260245ffd5b3461013c575f36600319011261013c57602060405160ff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b3461013c57606036600319011261013c57610538610796565b6105406107ac565b6001600160a01b0382165f818152600160209081526040808320338452909152902054909260443592915f19811061057e575b506101b693506107c2565b8381106105e35784156105d05733156105bd576101b6945f52600160205260405f2060018060a01b0333165f526020528360405f209103905584610573565b634a1406b160e11b5f525f60045260245ffd5b63e602df0560e01b5f525f60045260245ffd5b8390637dc7a0d960e11b5f523360045260245260445260645ffd5b3461013c575f36600319011261013c576020600254604051908152f35b3461013c57604036600319011261013c57610634610796565b6024359033156105d0576001600160a01b03169081156105bd57335f52600160205260405f20825f526020528060405f20556040519081527f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560203392a3602060405160018152f35b3461013c575f36600319011261013c575f6003548060011c90600181168015610762575b6020831081146102be578285529081156102a2575060011461070d5750819003601f01601f191681019067ffffffffffffffff821181831017610239576102358291826040528261076c565b905060035f527fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b5f905b82821061074c57506020915082010182610205565b6001816020925483858801015201910190610737565b91607f16916106c1565b602060409281835280519182918282860152018484015e5f828201840152601f01601f1916010190565b600435906001600160a01b038216820361013c57565b602435906001600160a01b038216820361013c57565b6001600160a01b0316908115610423576001600160a01b03169182156104cf57815f525f60205260405f205481811061084057817fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef92602092855f525f84520360405f2055845f525f825260405f20818154019055604051908152a3565b8263391434e360e21b5f5260045260245260445260645ffd5b6005546001600160a01b0316330361086d57565b63118cdaa760e01b5f523360045260245ffdfea2646970667358221220c4965597c6a3e88a7e6f7669f04cfdc338062b72a2907643b0972300c58c3f3964736f6c634300081c0033' as `0x${string}`;

// Hook for LS-LMSR market creation (recommended for new markets)
export function useLSLMSRMarketCreate() {
  const { address } = useAccount();
  const publicClient = usePublicClient();
  const { data: walletClient } = useWalletClient();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const createMarket = useCallback(async (
    config: LSLMSRMarketConfig,
    addLog: (msg: string, type: LogType, txHash?: string) => void
  ): Promise<{ marketAddress: Address; yesToken: Address; noToken: Address; txHash: string } | null> => {
    if (!address || !walletClient || !publicClient) {
      setError('Wallet not connected');
      addLog('Wallet not connected', 'error');
      return null;
    }

    if (LSLMSR_BYTECODE === '0x') {
      setError('LS-LMSR bytecode not compiled. Please compile contracts/LSLMSR.sol first.');
      addLog('LS-LMSR bytecode not available. Compile the contract first.', 'error');
      return null;
    }

    setIsLoading(true);
    setError(null);

    try {
      addLog(`Deploying LS-LMSR market with Î±=${config.alpha}...`, 'pending');

      const resolutionTime = BigInt(Math.floor(new Date(config.resolutionDate).getTime() / 1000));
      const oracle = (config.oracle || address) as Address;
      const alpha = parseEther(config.alpha);
      const minLiquidity = parseEther(config.minLiquidity);
      const initialYesShares = parseEther(config.initialYesShares);
      const initialNoShares = parseEther(config.initialNoShares);

      // Calculate liquidity buffer (minimum 1 MON required by contract)
      // Recommended: 2-5% of expected total trading volume for solvency
      const liquidityBuffer = config.initialLiquidity && parseFloat(config.initialLiquidity) >= 1
        ? parseEther(config.initialLiquidity)
        : parseEther('1');

      if (parseFloat(config.initialLiquidity) < 1) {
        addLog('Warning: Minimum 1 MON buffer required', 'error');
        throw new Error('Minimum liquidity buffer is 1 MON');
      }

      addLog(`Liquidity buffer: ${formatEther(liquidityBuffer)} MON`, 'info');

      // Deploy LSLMSR contract with liquidity buffer
      // Protocol fees automatically transfer to 0x048c2c9E869594a70c6Dc7CeAC168E724425cdFE on every trade
      const hash = await walletClient.deployContract({
        abi: LSLMSR_ABI,
        bytecode: LSLMSR_BYTECODE,
        args: [
          config.question,
          resolutionTime,
          oracle,
          alpha,
          minLiquidity,
          initialYesShares,
          initialNoShares,
          config.yesName,
          config.yesSymbol,
          config.noName,
          config.noSymbol,
        ],
        value: liquidityBuffer, // Required liquidity buffer for solvency
      });

      addLog('Waiting for confirmation...', 'pending', hash);

      const receipt = await publicClient.waitForTransactionReceipt({ hash });

      if (!receipt.contractAddress) {
        throw new Error('Contract deployment failed - no contract address in receipt');
      }

      const marketAddress = receipt.contractAddress as Address;
      addLog(`LS-LMSR Market deployed: ${marketAddress}`, 'success', hash);
      addLog(`Liquidity buffer deposited: ${formatEther(liquidityBuffer)} MON`, 'success');

      // Get token addresses from deployed contract
      const yesToken = await publicClient.readContract({
        address: marketAddress,
        abi: LSLMSR_ABI,
        functionName: 'yesToken',
      }) as Address;

      const noToken = await publicClient.readContract({
        address: marketAddress,
        abi: LSLMSR_ABI,
        functionName: 'noToken',
      }) as Address;

      addLog(`YES Token: ${yesToken}`, 'info');
      addLog(`NO Token: ${noToken}`, 'info');

      return { marketAddress, yesToken, noToken, txHash: hash };
    } catch (err: any) {
      const errorMsg = err.shortMessage || err.message || 'Failed to create market';
      setError(errorMsg);
      addLog(`Error: ${errorMsg}`, 'error');
      console.error('LS-LMSR Market creation error:', err);
      return null;
    } finally {
      setIsLoading(false);
    }
  }, [address, walletClient, publicClient]);

  return { createMarket, isLoading, error };
}

// Hook for legacy LMSR market creation
export function useLMSRMarketCreate() {
  const { address } = useAccount();
  const publicClient = usePublicClient();
  const { data: walletClient } = useWalletClient();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const createMarket = useCallback(async (
    config: LMSRMarketConfig,
    addLog: (msg: string, type: LogType, txHash?: string) => void
  ): Promise<{ marketAddress: Address; yesToken: Address; noToken: Address; txHash: string } | null> => {
    if (!address || !walletClient || !publicClient) {
      setError('Wallet not connected');
      addLog('Wallet not connected', 'error');
      return null;
    }

    setIsLoading(true);
    setError(null);

    try {
      addLog(`Deploying LMSR market...`, 'pending');

      const resolutionTime = BigInt(Math.floor(new Date(config.resolutionDate).getTime() / 1000));
      const oracle = (config.oracle || address) as Address;
      const liquidityParam = parseEther(config.liquidityParam);

      // Deploy LMSR contract (constructor is not payable)
      const hash = await walletClient.deployContract({
        abi: LMSR_ABI,
        bytecode: LMSR_BYTECODE,
        args: [
          config.question,
          resolutionTime,
          oracle,
          liquidityParam,
          config.yesName,
          config.yesSymbol,
          config.noName,
          config.noSymbol,
        ],
      });

      addLog('Waiting for confirmation...', 'pending', hash);

      const receipt = await publicClient.waitForTransactionReceipt({ hash });

      if (!receipt.contractAddress) {
        throw new Error('Contract deployment failed - no contract address in receipt');
      }

      const marketAddress = receipt.contractAddress as Address;
      addLog(`Market deployed: ${marketAddress}`, 'success', hash);

      // Add initial liquidity if specified
      if (config.initialLiquidity && parseFloat(config.initialLiquidity) > 0) {
        addLog('Adding initial liquidity...', 'pending');
        const liquidityHash = await walletClient.writeContract({
          address: marketAddress,
          abi: LMSR_ABI,
          functionName: 'addLiquidity',
          value: parseEther(config.initialLiquidity),
        });
        await publicClient.waitForTransactionReceipt({ hash: liquidityHash });
        addLog(`Added ${config.initialLiquidity} MON liquidity`, 'success', liquidityHash);
      }

      // Get token addresses from deployed contract
      const yesToken = await publicClient.readContract({
        address: marketAddress,
        abi: LMSR_ABI,
        functionName: 'yesToken',
      }) as Address;

      const noToken = await publicClient.readContract({
        address: marketAddress,
        abi: LMSR_ABI,
        functionName: 'noToken',
      }) as Address;

      addLog(`YES Token: ${yesToken}`, 'info');
      addLog(`NO Token: ${noToken}`, 'info');

      return { marketAddress, yesToken, noToken, txHash: hash };
    } catch (err: any) {
      const errorMsg = err.shortMessage || err.message || 'Failed to create market';
      setError(errorMsg);
      addLog(`Error: ${errorMsg}`, 'error');
      console.error('Market creation error:', err);
      return null;
    } finally {
      setIsLoading(false);
    }
  }, [address, walletClient, publicClient]);

  return { createMarket, isLoading, error };
}

// Hook for buying shares
export function useLMSRBuy() {
  const { address } = useAccount();
  const publicClient = usePublicClient();
  const { data: walletClient } = useWalletClient();
  const [isLoading, setIsLoading] = useState(false);

  const buy = useCallback(async (
    marketAddress: Address,
    isYes: boolean,
    amount: string,
    minShares: string,
    addLog: (msg: string, type: LogType, txHash?: string) => void
  ): Promise<{ success: boolean; txHash?: string; shares?: string }> => {
    if (!address || !walletClient || !publicClient) {
      addLog('Wallet not connected', 'error');
      return { success: false };
    }

    setIsLoading(true);

    try {
      addLog(`Buying ${isYes ? 'YES' : 'NO'} shares...`, 'pending');

      const hash = await walletClient.writeContract({
        address: marketAddress,
        abi: LSLMSR_ABI,
        functionName: 'buy',
        args: [isYes, parseEther(minShares || '0')],
        value: parseEther(amount),
      });

      const receipt = await publicClient.waitForTransactionReceipt({ hash });

      // Parse the SharesPurchased event to get the shares amount
      let shares = '0';
      for (const log of receipt.logs) {
        try {
          const decoded = decodeEventLog({
            abi: LSLMSR_ABI,
            data: log.data,
            topics: log.topics,
          });
          if (decoded.eventName === 'SharesPurchased') {
            const args = decoded.args as unknown as { shares: bigint };
            shares = formatEther(args.shares);
            break;
          }
        } catch {
          // Not our event, skip
        }
      }

      addLog(`Bought ${shares} ${isYes ? 'YES' : 'NO'} shares`, 'success', hash);
      return { success: true, txHash: hash, shares };
    } catch (err: any) {
      addLog(`Error: ${err.shortMessage || err.message}`, 'error');
      return { success: false };
    } finally {
      setIsLoading(false);
    }
  }, [address, walletClient, publicClient]);

  return { buy, isLoading };
}

// ERC20 ABI for token approval
const ERC20_ABI = [
  {
    name: 'approve',
    type: 'function',
    inputs: [
      { name: 'spender', type: 'address' },
      { name: 'amount', type: 'uint256' },
    ],
    outputs: [{ type: 'bool' }],
    stateMutability: 'nonpayable',
  },
  {
    name: 'allowance',
    type: 'function',
    inputs: [
      { name: 'owner', type: 'address' },
      { name: 'spender', type: 'address' },
    ],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'balanceOf',
    type: 'function',
    inputs: [{ name: 'account', type: 'address' }],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
] as const;

// Hook for selling shares
export function useLMSRSell() {
  const { address } = useAccount();
  const publicClient = usePublicClient();
  const { data: walletClient } = useWalletClient();
  const [isLoading, setIsLoading] = useState(false);

  const sell = useCallback(async (
    marketAddress: Address,
    isYes: boolean,
    sharesToSell: string,
    minPayout: string,
    addLog: (msg: string, type: LogType, txHash?: string) => void
  ): Promise<{ success: boolean; txHash?: string; shares?: string }> => {
    if (!address || !walletClient || !publicClient) {
      addLog('Wallet not connected', 'error');
      return { success: false };
    }

    setIsLoading(true);

    try {
      const sharesAmount = parseEther(sharesToSell);

      // Get the token address
      const tokenAddress = await publicClient.readContract({
        address: marketAddress,
        abi: LSLMSR_ABI,
        functionName: isYes ? 'yesToken' : 'noToken',
      }) as Address;

      addLog(`Checking ${isYes ? 'YES' : 'NO'} token allowance...`, 'pending');

      // Check current allowance
      const allowance = await publicClient.readContract({
        address: tokenAddress,
        abi: ERC20_ABI,
        functionName: 'allowance',
        args: [address, marketAddress],
      }) as bigint;

      // If allowance is insufficient, approve
      if (allowance < sharesAmount) {
        addLog(`Approving ${isYes ? 'YES' : 'NO'} tokens...`, 'pending');

        const approveHash = await walletClient.writeContract({
          address: tokenAddress,
          abi: ERC20_ABI,
          functionName: 'approve',
          args: [marketAddress, sharesAmount],
        });

        await publicClient.waitForTransactionReceipt({ hash: approveHash });
        addLog(`Approved ${sharesToSell} ${isYes ? 'YES' : 'NO'} tokens`, 'success', approveHash);
      }

      addLog(`Selling ${sharesToSell} ${isYes ? 'YES' : 'NO'} shares...`, 'pending');

      const hash = await walletClient.writeContract({
        address: marketAddress,
        abi: LSLMSR_ABI,
        functionName: 'sell',
        args: [isYes, sharesAmount, parseEther(minPayout || '0')],
      });

      const receipt = await publicClient.waitForTransactionReceipt({ hash });

      // Parse the SharesSold event to get the actual shares sold
      let shares = sharesToSell;
      for (const log of receipt.logs) {
        try {
          const decoded = decodeEventLog({
            abi: LSLMSR_ABI,
            data: log.data,
            topics: log.topics,
          });
          if (decoded.eventName === 'SharesSold') {
            const args = decoded.args as unknown as { shares: bigint };
            shares = formatEther(args.shares);
            break;
          }
        } catch {
          // Not our event, skip
        }
      }

      addLog(`Sold ${shares} ${isYes ? 'YES' : 'NO'} shares`, 'success', hash);
      return { success: true, txHash: hash, shares };
    } catch (err: any) {
      addLog(`Error: ${err.shortMessage || err.message}`, 'error');
      return { success: false };
    } finally {
      setIsLoading(false);
    }
  }, [address, walletClient, publicClient]);

  return { sell, isLoading };
}

// Hook for resolving market
export function useLMSRResolve() {
  const { address } = useAccount();
  const publicClient = usePublicClient();
  const { data: walletClient } = useWalletClient();
  const [isLoading, setIsLoading] = useState(false);

  const resolve = useCallback(async (
    marketAddress: Address,
    yesWins: boolean,
    addLog: (msg: string, type: LogType, txHash?: string) => void
  ): Promise<boolean> => {
    if (!address || !walletClient || !publicClient) {
      addLog('Wallet not connected', 'error');
      return false;
    }

    setIsLoading(true);

    try {
      addLog(`Resolving market: ${yesWins ? 'YES' : 'NO'} wins...`, 'pending');

      const hash = await walletClient.writeContract({
        address: marketAddress,
        abi: LSLMSR_ABI,
        functionName: 'resolve',
        args: [yesWins],
      });

      await publicClient.waitForTransactionReceipt({ hash });

      addLog(`Market resolved: ${yesWins ? 'YES' : 'NO'} wins`, 'success', hash);
      return true;
    } catch (err: any) {
      addLog(`Error: ${err.shortMessage || err.message}`, 'error');
      return false;
    } finally {
      setIsLoading(false);
    }
  }, [address, walletClient, publicClient]);

  return { resolve, isLoading };
}

// Hook for redeeming winnings
export function useLMSRRedeem() {
  const { address } = useAccount();
  const publicClient = usePublicClient();
  const { data: walletClient } = useWalletClient();
  const [isLoading, setIsLoading] = useState(false);

  const redeem = useCallback(async (
    marketAddress: Address,
    addLog: (msg: string, type: LogType, txHash?: string) => void
  ): Promise<{ success: boolean; txHash?: string; shares?: string; payout?: string; yesWins?: boolean }> => {
    if (!address || !walletClient || !publicClient) {
      addLog('Wallet not connected', 'error');
      return { success: false };
    }

    setIsLoading(true);

    try {
      // First get market info to determine winning outcome and check if resolved
      // LS-LMSR getMarketInfo returns: question, resolutionTime, oracle, yesPrice, noPrice,
      // yesProbability, noProbability, yesShares, noShares, totalCollateral, liquidityParam, priceSum, resolved, yesWins
      const info = await publicClient.readContract({
        address: marketAddress,
        abi: LSLMSR_ABI,
        functionName: 'getMarketInfo',
      }) as [string, bigint, Address, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, boolean, boolean];

      const resolved = info[12];
      const yesWins = info[13];

      if (!resolved) {
        addLog('Market is not resolved yet', 'error');
        return { success: false };
      }

      // Get the winning token address
      const winningTokenAddress = await publicClient.readContract({
        address: marketAddress,
        abi: LSLMSR_ABI,
        functionName: yesWins ? 'yesToken' : 'noToken',
      }) as Address;

      // Check user's balance of winning tokens
      const balance = await publicClient.readContract({
        address: winningTokenAddress,
        abi: ERC20_ABI,
        functionName: 'balanceOf',
        args: [address],
      }) as bigint;

      if (balance === 0n) {
        addLog('No winning tokens to redeem', 'error');
        return { success: false };
      }

      addLog(`Found ${formatEther(balance)} winning tokens`, 'info');

      // Check allowance and approve if needed
      const allowance = await publicClient.readContract({
        address: winningTokenAddress,
        abi: ERC20_ABI,
        functionName: 'allowance',
        args: [address, marketAddress],
      }) as bigint;

      if (allowance < balance) {
        addLog('Approving tokens for redemption...', 'pending');
        const approveHash = await walletClient.writeContract({
          address: winningTokenAddress,
          abi: ERC20_ABI,
          functionName: 'approve',
          args: [marketAddress, balance],
        });
        await publicClient.waitForTransactionReceipt({ hash: approveHash });
        addLog('Tokens approved', 'success');
      }

      addLog(`Redeeming winnings...`, 'pending');

      const hash = await walletClient.writeContract({
        address: marketAddress,
        abi: LSLMSR_ABI,
        functionName: 'redeem',
      });

      const receipt = await publicClient.waitForTransactionReceipt({ hash });

      // Try to parse the Redeemed event to get shares and payout
      let shares = '0';
      let payout = '0';
      for (const log of receipt.logs) {
        try {
          const decoded = decodeEventLog({
            abi: LSLMSR_ABI,
            data: log.data,
            topics: log.topics,
          });
          if (decoded.eventName === 'Redeemed') {
            const args = decoded.args as unknown as { user: Address; shares: bigint; payout: bigint };
            shares = formatEther(args.shares);
            // Payout is in collateral decimals (6 for USDC), not 18
            payout = formatUnits(args.payout, 6);
          }
        } catch {
          // Not this event, continue
        }
      }

      addLog(`Redeemed ${shares} shares for ${payout} USDC`, 'success', hash);
      return { success: true, txHash: hash, shares, payout, yesWins };
    } catch (err: any) {
      addLog(`Error: ${err.shortMessage || err.message}`, 'error');
      return { success: false };
    } finally {
      setIsLoading(false);
    }
  }, [address, walletClient, publicClient]);

  return { redeem, isLoading };
}

// Hook for claiming creator fees
export function useClaimCreatorFees() {
  const { address } = useAccount();
  const publicClient = usePublicClient();
  const { data: walletClient } = useWalletClient();
  const [isLoading, setIsLoading] = useState(false);

  const claimFees = useCallback(async (
    marketAddress: Address,
    addLog: (msg: string, type: LogType, txHash?: string) => void
  ): Promise<{ success: boolean; txHash?: string; amount?: string }> => {
    if (!address || !walletClient || !publicClient) {
      addLog('Wallet not connected', 'error');
      return { success: false };
    }

    setIsLoading(true);

    try {
      // Check fee info first - getFeeInfo returns [creatorFeesAccrued, totalProtocolFeesSent]
      const feeInfo = await publicClient.readContract({
        address: marketAddress,
        abi: LSLMSR_ABI,
        functionName: 'getFeeInfo',
      }) as [bigint, bigint];

      const creatorFees = feeInfo[0];

      if (creatorFees === 0n) {
        addLog('No creator fees to claim', 'error');
        return { success: false };
      }

      addLog(`Claiming ${formatEther(creatorFees)} MON in creator fees...`, 'pending');

      const hash = await walletClient.writeContract({
        address: marketAddress,
        abi: LSLMSR_ABI,
        functionName: 'claimCreatorFees',
      });

      await publicClient.waitForTransactionReceipt({ hash });

      const amount = formatEther(creatorFees);
      addLog(`Claimed ${amount} MON in creator fees`, 'success', hash);
      return { success: true, txHash: hash, amount };
    } catch (err: any) {
      addLog(`Error: ${err.shortMessage || err.message}`, 'error');
      return { success: false };
    } finally {
      setIsLoading(false);
    }
  }, [address, walletClient, publicClient]);

  return { claimFees, isLoading };
}

// Protocol fees are now auto-transferred to 0x048c2c9E869594a70c6Dc7CeAC168E724425cdFE on every trade
// This hook is kept for backwards compatibility but no longer has a claimProtocolFees function
export function useClaimProtocolFees() {
  // Protocol fees are auto-transferred on every trade, no claiming needed
  return {
    claimProtocolFees: async () => ({ success: false, error: 'Protocol fees are auto-transferred on every trade' }),
    isLoading: false
  };
}

// Hook for reading fee info for a market
// Note: Protocol fees are now auto-transferred on every trade to 0x048c2c9E869594a70c6Dc7CeAC168E724425cdFE
export function useMarketFees(marketAddress: Address | undefined) {
  const { address } = useAccount();
  const publicClient = usePublicClient();
  const [feeInfo, setFeeInfo] = useState<{
    creatorFees: string; // Pending creator fees that can be claimed (100% of 0.5% trading fee)
    marketCreator: Address | null;
    isMarketCreator: boolean;
    canClaimCreatorFees: boolean;
  } | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const fetchFeeInfo = useCallback(async () => {
    if (!publicClient || !marketAddress) {
      setFeeInfo(null);
      return;
    }

    setIsLoading(true);
    try {
      const [pendingCreatorFees, marketCreator, resolved, resolutionTime] = await Promise.all([
        publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'getFeeInfo',
        }) as Promise<bigint>, // Returns single value: pendingCreatorFees
        publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'marketCreator',
        }) as Promise<Address>,
        publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'resolved',
        }) as Promise<boolean>,
        publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'resolutionTime',
        }) as Promise<bigint>,
      ]);

      const now = BigInt(Math.floor(Date.now() / 1000));
      const isMarketCreator = address?.toLowerCase() === marketCreator.toLowerCase();

      // Creator fees can only be claimed after resolution OR after resolution time passes
      const canClaimCreatorFees = isMarketCreator && (resolved || now >= resolutionTime);

      setFeeInfo({
        creatorFees: formatEther(pendingCreatorFees),
        marketCreator,
        isMarketCreator,
        canClaimCreatorFees: canClaimCreatorFees && pendingCreatorFees > 0n,
      });
    } catch (err) {
      console.error('Failed to fetch fee info:', err);
      setFeeInfo(null);
    } finally {
      setIsLoading(false);
    }
  }, [publicClient, marketAddress, address]);

  useEffect(() => {
    fetchFeeInfo();
  }, [fetchFeeInfo]);

  return { feeInfo, isLoading, refetch: fetchFeeInfo };
}

// Hook for reading market data
export function useLMSRMarketData(marketAddress: Address | undefined) {
  const { data: marketInfo, refetch } = useReadContract({
    address: marketAddress,
    abi: LMSR_ABI,
    functionName: 'getMarketInfo',
    query: { enabled: !!marketAddress },
  });

  if (!marketInfo) {
    return { marketInfo: null, refetch };
  }

  const [question, resolutionTime, oracle, yesPrice, noPrice, yesShares, noShares, totalCollateral, resolved, yesWins] = marketInfo as [string, bigint, Address, bigint, bigint, bigint, bigint, bigint, boolean, boolean];

  return {
    marketInfo: {
      question,
      resolutionTime,
      oracle,
      yesPrice,
      noPrice,
      yesShares,
      noShares,
      totalCollateral,
      resolved,
      yesWins,
    } as MarketInfo,
    refetch,
  };
}

// Hook for estimating shares using binary search on getCost
// Client-side LMSR math functions (matches Solidity implementation)
function lmsrExp(x: number): number {
  // Cap x to prevent overflow (e^6 â‰ˆ 403)
  if (x > 6) x = 6;
  return Math.exp(x);
}

function lmsrLn(x: number): number {
  if (x <= 1) return 0;
  return Math.log(x);
}

function lmsrCostFunction(yesShares: number, noShares: number, b: number): number {
  // C(q) = b * ln(e^(qYes/b) + e^(qNo/b))
  const expYes = lmsrExp(yesShares / b);
  const expNo = lmsrExp(noShares / b);
  return b * lmsrLn(expYes + expNo);
}

function lmsrGetCost(
  currentYesShares: number,
  currentNoShares: number,
  b: number,
  isYes: boolean,
  sharesToBuy: number
): number {
  const newYes = isYes ? currentYesShares + sharesToBuy : currentYesShares;
  const newNo = isYes ? currentNoShares : currentNoShares + sharesToBuy;

  const newCost = lmsrCostFunction(newYes, newNo, b);
  const currentCost = lmsrCostFunction(currentYesShares, currentNoShares, b);

  return Math.max(0, newCost - currentCost);
}

export function useLMSREstimateShares() {
  const publicClient = usePublicClient();

  const estimateShares = useCallback(async (
    marketAddress: Address,
    isYes: boolean,
    paymentAmount: string
  ): Promise<string> => {
    if (!publicClient || !paymentAmount || parseFloat(paymentAmount) <= 0) {
      return '0';
    }

    try {
      const payment = parseFloat(paymentAmount);

      // Single RPC call to get market state
      const [info, b] = await Promise.all([
        publicClient.readContract({
          address: marketAddress,
          abi: LMSR_ABI,
          functionName: 'getMarketInfo',
        }) as Promise<[string, bigint, Address, bigint, bigint, bigint, bigint, bigint, boolean, boolean]>,
        publicClient.readContract({
          address: marketAddress,
          abi: LMSR_ABI,
          functionName: 'b',
        }) as Promise<bigint>,
      ]);

      const yesShares = Number(formatEther(info[5]));
      const noShares = Number(formatEther(info[6]));
      const bValue = Number(formatEther(b));

      // Client-side binary search (instant, no RPC calls)
      let low = 0;
      let high = payment * 10;

      for (let i = 0; i < 50; i++) {
        const mid = (low + high) / 2;
        const cost = lmsrGetCost(yesShares, noShares, bValue, isYes, mid);

        if (cost <= payment) {
          low = mid;
        } else {
          high = mid;
        }

        if (high - low < 0.0001) break;
      }

      return low.toFixed(6);
    } catch (err) {
      console.error('Error estimating shares:', err);
      return '0';
    }
  }, [publicClient]);

  return { estimateShares };
}

// ============ LS-LMSR Specific Hooks ============

// Hook for reading LS-LMSR market data (extended with probability and price sum)
export function useLSLMSRMarketData(marketAddress: Address | undefined) {
  const { data: marketInfo, refetch } = useReadContract({
    address: marketAddress,
    abi: LSLMSR_ABI,
    functionName: 'getMarketInfo',
    query: { enabled: !!marketAddress },
  });

  if (!marketInfo) {
    return { marketInfo: null, refetch };
  }

  const [
    question,
    resolutionTime,
    oracle,
    yesPrice,
    noPrice,
    yesProbability,
    noProbability,
    yesShares,
    noShares,
    totalCollateral,
    liquidityParam,
    priceSum,
    resolved,
    yesWins
  ] = marketInfo as [string, bigint, Address, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, boolean, boolean];

  return {
    marketInfo: {
      question,
      resolutionTime,
      oracle,
      yesPrice,
      noPrice,
      yesProbability,
      noProbability,
      yesShares,
      noShares,
      totalCollateral,
      liquidityParam,
      priceSum,
      resolved,
      yesWins,
    } as LSLMSRMarketInfo,
    refetch,
  };
}

// LS-LMSR client-side math functions (dynamic b)
function lslmsrLiquidityParameter(yesShares: number, noShares: number, alpha: number, minLiquidity: number): number {
  const totalShares = yesShares + noShares;
  const dynamicB = alpha * totalShares;
  return Math.max(dynamicB, minLiquidity);
}

function lslmsrCostFunction(yesShares: number, noShares: number, alpha: number, minLiquidity: number): number {
  const b = lslmsrLiquidityParameter(yesShares, noShares, alpha, minLiquidity);
  const expYes = lmsrExp(yesShares / b);
  const expNo = lmsrExp(noShares / b);
  return b * lmsrLn(expYes + expNo);
}

function lslmsrGetCost(
  currentYesShares: number,
  currentNoShares: number,
  alpha: number,
  minLiquidity: number,
  isYes: boolean,
  sharesToBuy: number
): number {
  const newYes = isYes ? currentYesShares + sharesToBuy : currentYesShares;
  const newNo = isYes ? currentNoShares : currentNoShares + sharesToBuy;

  const newCost = lslmsrCostFunction(newYes, newNo, alpha, minLiquidity);
  const currentCost = lslmsrCostFunction(currentYesShares, currentNoShares, alpha, minLiquidity);

  return Math.max(0, newCost - currentCost);
}

// Hook for estimating shares in LS-LMSR markets
export function useLSLMSREstimateShares() {
  const publicClient = usePublicClient();

  const estimateShares = useCallback(async (
    marketAddress: Address,
    isYes: boolean,
    paymentAmount: string
  ): Promise<string> => {
    if (!publicClient || !paymentAmount || parseFloat(paymentAmount) <= 0) {
      return '0';
    }

    try {
      const payment = parseFloat(paymentAmount);

      // Get market state and parameters
      const [info, alpha, minLiquidity] = await Promise.all([
        publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'getMarketInfo',
        }) as Promise<[string, bigint, Address, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, boolean, boolean]>,
        publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'alpha',
        }) as Promise<bigint>,
        publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'minLiquidity',
        }) as Promise<bigint>,
      ]);

      const yesShares = Number(formatEther(info[7])); // index 7 in LS-LMSR
      const noShares = Number(formatEther(info[8])); // index 8 in LS-LMSR
      const alphaValue = Number(formatEther(alpha));
      const minLiquidityValue = Number(formatEther(minLiquidity));

      // Client-side binary search with dynamic b
      let low = 0;
      let high = payment * 10;

      for (let i = 0; i < 50; i++) {
        const mid = (low + high) / 2;
        const cost = lslmsrGetCost(yesShares, noShares, alphaValue, minLiquidityValue, isYes, mid);

        if (cost <= payment) {
          low = mid;
        } else {
          high = mid;
        }

        if (high - low < 0.0001) break;
      }

      return low.toFixed(6);
    } catch (err) {
      console.error('Error estimating LS-LMSR shares:', err);
      return '0';
    }
  }, [publicClient]);

  return { estimateShares };
}

// Generic market type detection
export function useMarketType(marketAddress: Address | undefined) {
  const publicClient = usePublicClient();
  const [marketType, setMarketType] = useState<'LMSR' | 'LSLMSR' | null>(null);

  useEffect(() => {
    const detectType = async () => {
      if (!publicClient || !marketAddress) {
        setMarketType(null);
        return;
      }

      try {
        // Try to read alpha - only exists in LS-LMSR
        await publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'alpha',
        });
        setMarketType('LSLMSR');
      } catch {
        // If alpha doesn't exist, it's legacy LMSR
        setMarketType('LMSR');
      }
    };

    detectType();
  }, [publicClient, marketAddress]);

  return marketType;
}

// ============ Unified Hooks for Trading Interface ============

// Unified market data hook that auto-detects market type
export function useUnifiedMarketData(marketAddress: Address | undefined) {
  const publicClient = usePublicClient();
  const [marketInfo, setMarketInfo] = useState<MarketInfo | null>(null);
  const [marketType, setMarketType] = useState<'LMSR' | 'LSLMSR' | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const refetch = useCallback(async () => {
    if (!publicClient || !marketAddress) {
      setMarketInfo(null);
      setMarketType(null);
      return;
    }

    setIsLoading(true);
    try {
      // Try LS-LMSR first (check for alpha)
      try {
        await publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'alpha',
          blockTag: 'latest', // Force fresh read
        });

        // It's LS-LMSR
        setMarketType('LSLMSR');
        const info = await publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'getMarketInfo',
          blockTag: 'latest', // Force fresh read
        }) as [string, bigint, Address, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, boolean, boolean];

        // Check if it's an ERC20 collateral market (has collateralDecimals function)
        let collateralDecimals = 18;
        let collateralSymbol = 'MON';
        try {
          const decimals = await publicClient.readContract({
            address: marketAddress,
            abi: [{ name: 'collateralDecimals', type: 'function', inputs: [], outputs: [{ type: 'uint8' }], stateMutability: 'view' }],
            functionName: 'collateralDecimals',
            blockTag: 'latest',
          }) as number;
          collateralDecimals = decimals;
          // If it has collateralDecimals, it's ERC20 - likely USDC
          collateralSymbol = collateralDecimals === 6 ? 'USDC' : 'TOKEN';
        } catch {
          // Native collateral market (18 decimals)
        }

        setMarketInfo({
          question: info[0],
          resolutionTime: info[1],
          oracle: info[2],
          yesPrice: info[3],
          noPrice: info[4],
          yesProbability: info[5],
          noProbability: info[6],
          yesShares: info[7],
          noShares: info[8],
          totalCollateral: info[9],
          resolved: info[12],
          yesWins: info[13],
          collateralDecimals,
          collateralSymbol,
        });
      } catch {
        // It's legacy LMSR
        setMarketType('LMSR');
        const info = await publicClient.readContract({
          address: marketAddress,
          abi: LMSR_ABI,
          functionName: 'getMarketInfo',
          blockTag: 'latest', // Force fresh read
        }) as [string, bigint, Address, bigint, bigint, bigint, bigint, bigint, boolean, boolean];

        setMarketInfo({
          question: info[0],
          resolutionTime: info[1],
          oracle: info[2],
          yesPrice: info[3],
          noPrice: info[4],
          yesShares: info[5],
          noShares: info[6],
          totalCollateral: info[7],
          resolved: info[8],
          yesWins: info[9],
          collateralDecimals: 18, // Legacy LMSR uses native token
          collateralSymbol: 'MON',
        });
      }
    } catch (err) {
      console.error('Error fetching market data:', err);
      setMarketInfo(null);
    } finally {
      setIsLoading(false);
    }
  }, [publicClient, marketAddress]);

  useEffect(() => {
    refetch();
    // Poll for price updates every 15 seconds to avoid rate limiting
    const interval = setInterval(refetch, 15000);
    return () => clearInterval(interval);
  }, [refetch]);

  return { marketInfo, marketType, isLoading, refetch };
}

// LS-LMSR math helpers for JavaScript fallback
const TRADING_FEE_BPS = 50n; // 0.5% - 100% goes to market creator
const FEE_DENOMINATOR = 10000n;
const SCALE = BigInt(1e18);

// Approximate e^x where x is scaled by 1e18
function expApprox(x: bigint): bigint {
  // Cap x to prevent overflow (e^6 â‰ˆ 403)
  const cap = 6n * SCALE;
  if (x > cap) x = cap;

  // Taylor series: e^x = 1 + x + x^2/2! + x^3/3! + ...
  let result = SCALE;
  let term = SCALE;

  for (let i = 1n; i <= 12n; i++) {
    term = (term * x) / (i * SCALE);
    result += term;
    if (term < 1n) break;
  }

  return result;
}

// Approximate ln(x) where x is scaled by 1e18
function lnApprox(x: bigint): bigint {
  if (x < SCALE) return 0n;
  if (x === SCALE) return 0n;

  const LN2 = 693147180559945309n; // ln(2) scaled by 1e18

  // Reduce x to range [1, 2) by dividing by 2
  let halvings = 0n;
  while (x >= 2n * SCALE) {
    x = x / 2n;
    halvings++;
  }

  // Now 1e18 <= x < 2e18, so y = x - 1e18 is in [0, 1e18)
  const y = x - SCALE;

  if (y === 0n) {
    return halvings * LN2;
  }

  // ln(1+y) = y - y^2/2 + y^3/3 - ... (Taylor series)
  let result = 0n;
  let term = y;
  let positive = true;

  for (let i = 1n; i <= 30n; i++) {
    if (positive) {
      result += term / i;
    } else {
      result -= term / i;
    }
    term = (term * y) / SCALE;
    positive = !positive;
    if (term < 1n) break;
  }

  return result + halvings * LN2;
}

// Calculate LS-LMSR cost function using log-sum-exp trick:
// C(q) = max(yes,no) + b * ln(exp(0) + exp(-(|yes-no|)/b))
// This avoids overflow in exp() by keeping arguments bounded to the difference.
function costFunction(yesShares: bigint, noShares: bigint, alpha: bigint, minLiquidity: bigint): bigint {
  const totalShares = yesShares + noShares;
  if (totalShares === 0n) return 0n;

  let b = (alpha * totalShares) / SCALE;
  if (b < minLiquidity) b = minLiquidity;
  if (b === 0n) b = SCALE; // Fallback to prevent division by zero

  const maxShares = yesShares > noShares ? yesShares : noShares;

  // Log-sum-exp trick: factor out max(yes,no)/b from the exp terms
  // C = max + b * ln(exp(0) + exp(-gap/b)) where gap = |yes - no|
  let expYes: bigint;
  let expNo: bigint;

  if (yesShares >= noShares) {
    expYes = SCALE; // exp(0) = 1
    const gap = yesShares - noShares;
    if (gap === 0n) {
      expNo = SCALE;
    } else {
      const expArg = (gap * SCALE) / b;
      const expGap = expApprox(expArg);
      expNo = (SCALE * SCALE) / expGap; // exp(-gap/b) = 1/exp(gap/b)
    }
  } else {
    expNo = SCALE; // exp(0) = 1
    const gap = noShares - yesShares;
    if (gap === 0n) {
      expYes = SCALE;
    } else {
      const expArg = (gap * SCALE) / b;
      const expGap = expApprox(expArg);
      expYes = (SCALE * SCALE) / expGap; // exp(-gap/b) = 1/exp(gap/b)
    }
  }

  const sum = expYes + expNo;
  const lnSum = lnApprox(sum);

  // C = maxShares + b * ln(sum)
  return maxShares + (b * lnSum) / SCALE;
}

// Calculate cost to buy shares
function getCost(
  isYes: boolean,
  shares: bigint,
  yesShares: bigint,
  noShares: bigint,
  alpha: bigint,
  minLiquidity: bigint
): bigint {
  const newYes = isYes ? yesShares + shares : yesShares;
  const newNo = isYes ? noShares : noShares + shares;

  const newCost = costFunction(newYes, newNo, alpha, minLiquidity);
  const currentCost = costFunction(yesShares, noShares, alpha, minLiquidity);

  return newCost > currentCost ? newCost - currentCost : 0n;
}

// Binary search for shares given payment
function calculateSharesForPayment(
  isYes: boolean,
  payment: bigint,
  yesShares: bigint,
  noShares: bigint,
  alpha: bigint,
  minLiquidity: bigint
): bigint {
  if (payment === 0n) return 0n;

  let low = 0n;
  // Upper bound: 100x payment handles outcomes with very low prices (e.g., 1% probability)
  let high = payment * 100n;

  for (let i = 0; i < 64; i++) {
    const mid = (low + high) / 2n;
    const cost = getCost(isYes, mid, yesShares, noShares, alpha, minLiquidity);

    if (cost <= payment) {
      low = mid;
    } else {
      high = mid;
    }

    if (high - low <= 1n) break;
  }

  return low;
}

// Unified share estimation that auto-detects market type
export function useUnifiedEstimateShares() {
  const publicClient = usePublicClient();

  const estimateShares = useCallback(async (
    marketAddress: Address,
    isYes: boolean,
    paymentAmount: string,
    collateralDecimals: number = 18 // Default to 18 for native token
  ): Promise<string> => {
    if (!publicClient || !paymentAmount || parseFloat(paymentAmount) <= 0) {
      return '0';
    }

    try {
      // Parse with correct collateral decimals
      const grossPayment = parseUnits(paymentAmount, collateralDecimals);

      // Use JS estimation â€” deployed contracts have a binary search upper bound
      // bug (high = payment * 2) that caps shares at ~2x payment regardless of price.
      // JS implementation uses payment * 100 which handles low-probability outcomes.
      const [yesShares, noShares, alpha, minLiquidity] = await Promise.all([
        publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'yesShares',
        }) as Promise<bigint>,
        publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'noShares',
        }) as Promise<bigint>,
        publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'alpha',
        }) as Promise<bigint>,
        publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'minLiquidity',
        }) as Promise<bigint>,
      ]);

      // Deduct 0.5% trading fee
      const paymentAfterFee = grossPayment - (grossPayment * TRADING_FEE_BPS) / FEE_DENOMINATOR;

      // Scale payment to 18-decimal share scale (matches Solidity SHARE_SCALE)
      const shareScale = BigInt(10 ** (18 - collateralDecimals));
      const paymentInShareScale = paymentAfterFee * shareScale;

      // Calculate shares using JS LS-LMSR cost function with binary search
      const shares = calculateSharesForPayment(
        isYes,
        paymentInShareScale,
        yesShares,
        noShares,
        alpha,
        minLiquidity
      );

      return formatEther(shares);
    } catch (err) {
      console.error('Error estimating shares:', err);
      return '0';
    }
  }, [publicClient]);

  return { estimateShares };
}
