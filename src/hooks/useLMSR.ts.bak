import { useState, useCallback, useEffect } from 'react';
import {
  useAccount,
  usePublicClient,
  useWalletClient,
  useReadContract,
} from 'wagmi';
import { parseEther, formatEther, decodeEventLog, type Address } from 'viem';

export type LogType = 'info' | 'success' | 'error' | 'pending';

export interface LogEntry {
  timestamp: string;
  msg: string;
  type: LogType;
  txHash?: string;
}

export interface LMSRMarketConfig {
  question: string;
  resolutionDate: string;
  oracle: string;
  liquidityParam: string; // e.g., "100" for 100 MON worth of liquidity depth (legacy LMSR)
  yesName: string;
  yesSymbol: string;
  noName: string;
  noSymbol: string;
  initialLiquidity: string; // MON to seed the market
}

// LS-LMSR specific config (extends base config)
export interface LSLMSRMarketConfig {
  question: string;
  resolutionDate: string;
  oracle: string;
  alpha: string; // e.g., "0.03" for 3% max spread
  minLiquidity: string; // e.g., "10" minimum effective b
  initialYesShares: string; // e.g., "100" initial YES shares for bootstrapping
  initialNoShares: string; // e.g., "100" initial NO shares for bootstrapping
  yesName: string;
  yesSymbol: string;
  noName: string;
  noSymbol: string;
  initialLiquidity: string; // MON to seed the market
  protocolFeeRecipient: string; // Address to receive 50% of trading fees
}

export interface MarketInfo {
  question: string;
  resolutionTime: bigint;
  oracle: Address;
  yesPrice: bigint;
  noPrice: bigint;
  yesShares: bigint;
  noShares: bigint;
  totalCollateral: bigint;
  resolved: boolean;
  yesWins: boolean;
}

// Extended market info for LS-LMSR
export interface LSLMSRMarketInfo extends MarketInfo {
  yesProbability: bigint;
  noProbability: bigint;
  liquidityParam: bigint;
  priceSum: bigint;
}

// Hook for logging
export function useTransactionLog() {
  const [logs, setLogs] = useState<LogEntry[]>([]);

  const addLog = useCallback((msg: string, type: LogType = 'info', txHash?: string) => {
    const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
    setLogs(prev => [...prev, { timestamp, msg, type, txHash }].slice(-100));
  }, []);

  const clearLogs = useCallback(() => setLogs([]), []);

  return { logs, addLog, clearLogs };
}

// LS-LMSR ABI for liquidity-sensitive market maker
export const LSLMSR_ABI = [
  // Constructor
  {
    type: 'constructor',
    inputs: [
      { name: '_question', type: 'string' },
      { name: '_resolutionTime', type: 'uint256' },
      { name: '_oracle', type: 'address' },
      { name: '_alpha', type: 'uint256' },
      { name: '_minLiquidity', type: 'uint256' },
      { name: '_initialYesShares', type: 'uint256' },
      { name: '_initialNoShares', type: 'uint256' },
      { name: '_yesName', type: 'string' },
      { name: '_yesSymbol', type: 'string' },
      { name: '_noName', type: 'string' },
      { name: '_noSymbol', type: 'string' },
      { name: '_protocolFeeRecipient', type: 'address' },
    ],
  },
  // View functions
  {
    name: 'getMarketInfo',
    type: 'function',
    inputs: [],
    outputs: [
      { name: '_question', type: 'string' },
      { name: '_resolutionTime', type: 'uint256' },
      { name: '_oracle', type: 'address' },
      { name: '_yesPrice', type: 'uint256' },
      { name: '_noPrice', type: 'uint256' },
      { name: '_yesProbability', type: 'uint256' },
      { name: '_noProbability', type: 'uint256' },
      { name: '_yesShares', type: 'uint256' },
      { name: '_noShares', type: 'uint256' },
      { name: '_totalCollateral', type: 'uint256' },
      { name: '_liquidityParam', type: 'uint256' },
      { name: '_priceSum', type: 'uint256' },
      { name: '_resolved', type: 'bool' },
      { name: '_yesWins', type: 'bool' },
    ],
    stateMutability: 'view',
  },
  {
    name: 'getCost',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'shares', type: 'uint256' },
    ],
    outputs: [{ name: 'cost', type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getPayoutForSell',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'shares', type: 'uint256' },
    ],
    outputs: [{ name: 'payout', type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getYesPrice',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getNoPrice',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getYesProbability',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getNoProbability',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getPriceSum',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'liquidityParameter',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'yesToken',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'address' }],
    stateMutability: 'view',
  },
  {
    name: 'noToken',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'address' }],
    stateMutability: 'view',
  },
  {
    name: 'question',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'string' }],
    stateMutability: 'view',
  },
  {
    name: 'alpha',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'minLiquidity',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'resolved',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'bool' }],
    stateMutability: 'view',
  },
  // Write functions
  {
    name: 'buy',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'minShares', type: 'uint256' },
    ],
    outputs: [],
    stateMutability: 'payable',
  },
  {
    name: 'sell',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'shares', type: 'uint256' },
      { name: 'minPayout', type: 'uint256' },
    ],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'resolve',
    type: 'function',
    inputs: [{ name: '_yesWins', type: 'bool' }],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'redeem',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'addLiquidity',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'payable',
  },
  {
    name: 'pause',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'unpause',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  // Fee functions
  {
    name: 'claimProtocolFees',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'claimCreatorFees',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'getPendingFees',
    type: 'function',
    inputs: [],
    outputs: [
      { name: 'protocolFees', type: 'uint256' },
      { name: 'creatorFees', type: 'uint256' },
    ],
    stateMutability: 'view',
  },
  {
    name: 'protocolFeesAccrued',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'creatorFeesAccrued',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'protocolFeeRecipient',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'address' }],
    stateMutability: 'view',
  },
  {
    name: 'marketCreator',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'address' }],
    stateMutability: 'view',
  },
  // Events
  {
    name: 'SharesPurchased',
    type: 'event',
    inputs: [
      { name: 'buyer', type: 'address', indexed: true },
      { name: 'isYes', type: 'bool', indexed: false },
      { name: 'shares', type: 'uint256', indexed: false },
      { name: 'cost', type: 'uint256', indexed: false },
    ],
  },
  {
    name: 'SharesSold',
    type: 'event',
    inputs: [
      { name: 'seller', type: 'address', indexed: true },
      { name: 'isYes', type: 'bool', indexed: false },
      { name: 'shares', type: 'uint256', indexed: false },
      { name: 'payout', type: 'uint256', indexed: false },
    ],
  },
  {
    name: 'Redeemed',
    type: 'event',
    inputs: [
      { name: 'user', type: 'address', indexed: true },
      { name: 'shares', type: 'uint256', indexed: false },
      { name: 'payout', type: 'uint256', indexed: false },
    ],
  },
  {
    name: 'OracleChanged',
    type: 'event',
    inputs: [
      { name: 'oldOracle', type: 'address', indexed: true },
      { name: 'newOracle', type: 'address', indexed: true },
    ],
  },
] as const;

// Legacy LMSR ABI for interactions (kept for backward compatibility)
export const LMSR_ABI = [
  // Constructor
  {
    type: 'constructor',
    inputs: [
      { name: '_question', type: 'string' },
      { name: '_resolutionTime', type: 'uint256' },
      { name: '_oracle', type: 'address' },
      { name: '_liquidityParam', type: 'uint256' },
      { name: '_yesName', type: 'string' },
      { name: '_yesSymbol', type: 'string' },
      { name: '_noName', type: 'string' },
      { name: '_noSymbol', type: 'string' },
    ],
  },
  // View functions
  {
    name: 'getMarketInfo',
    type: 'function',
    inputs: [],
    outputs: [
      { name: '_question', type: 'string' },
      { name: '_resolutionTime', type: 'uint256' },
      { name: '_oracle', type: 'address' },
      { name: '_yesPrice', type: 'uint256' },
      { name: '_noPrice', type: 'uint256' },
      { name: '_yesShares', type: 'uint256' },
      { name: '_noShares', type: 'uint256' },
      { name: '_totalCollateral', type: 'uint256' },
      { name: '_resolved', type: 'bool' },
      { name: '_yesWins', type: 'bool' },
    ],
    stateMutability: 'view',
  },
  {
    name: 'getCost',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'shares', type: 'uint256' },
    ],
    outputs: [{ name: 'cost', type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getPayoutForSell',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'shares', type: 'uint256' },
    ],
    outputs: [{ name: 'payout', type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getYesPrice',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'getNoPrice',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'yesToken',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'address' }],
    stateMutability: 'view',
  },
  {
    name: 'noToken',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'address' }],
    stateMutability: 'view',
  },
  {
    name: 'question',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'string' }],
    stateMutability: 'view',
  },
  {
    name: 'b',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'resolved',
    type: 'function',
    inputs: [],
    outputs: [{ type: 'bool' }],
    stateMutability: 'view',
  },
  // Write functions
  {
    name: 'buy',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'minShares', type: 'uint256' },
    ],
    outputs: [],
    stateMutability: 'payable',
  },
  {
    name: 'sell',
    type: 'function',
    inputs: [
      { name: 'isYes', type: 'bool' },
      { name: 'shares', type: 'uint256' },
      { name: 'minPayout', type: 'uint256' },
    ],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'resolve',
    type: 'function',
    inputs: [{ name: '_yesWins', type: 'bool' }],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'redeem',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'nonpayable',
  },
  {
    name: 'addLiquidity',
    type: 'function',
    inputs: [],
    outputs: [],
    stateMutability: 'payable',
  },
  // Events
  {
    name: 'SharesPurchased',
    type: 'event',
    inputs: [
      { name: 'buyer', type: 'address', indexed: true },
      { name: 'isYes', type: 'bool', indexed: false },
      { name: 'shares', type: 'uint256', indexed: false },
      { name: 'cost', type: 'uint256', indexed: false },
    ],
  },
  {
    name: 'SharesSold',
    type: 'event',
    inputs: [
      { name: 'seller', type: 'address', indexed: true },
      { name: 'isYes', type: 'bool', indexed: false },
      { name: 'shares', type: 'uint256', indexed: false },
      { name: 'payout', type: 'uint256', indexed: false },
    ],
  },
  {
    name: 'Redeemed',
    type: 'event',
    inputs: [
      { name: 'user', type: 'address', indexed: true },
      { name: 'shares', type: 'uint256', indexed: false },
      { name: 'payout', type: 'uint256', indexed: false },
    ],
  },
] as const;

// Legacy LMSR bytecode (compiled from contracts/LMSR.sol) - FIXED _ln function
const LMSR_BYTECODE = '0x60e060405234801562000010575f80fd5b5060405162002d2c38038062002d2c8339810160408190526200003391620002ab565b33806200005957604051631e4fbdf760e01b81525f600482015260240160405180910390fd5b62000064816200016c565b5060017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055600162000097898262000432565b506002879055600380546001600160a01b0319166001600160a01b03881617905560c0859052604051849084906012905f903090620000d690620001bb565b620000e69594939291906200052b565b604051809103905ff08015801562000100573d5f803e3d5ffd5b506001600160a01b0316608052604051829082906012905f9030906200012690620001bb565b620001369594939291906200052b565b604051809103905ff08015801562000150573d5f803e3d5ffd5b506001600160a01b031660a052506200057d9650505050505050565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b610ea58062001e8783390190565b634e487b7160e01b5f52604160045260245ffd5b5f5b83811015620001f9578181015183820152602001620001df565b50505f910152565b5f82601f83011262000211575f80fd5b81516001600160401b03808211156200022e576200022e620001c9565b604051601f8301601f19908116603f01168101908282118183101715620002595762000259620001c9565b8160405283815286602085880101111562000272575f80fd5b62000285846020830160208901620001dd565b9695505050505050565b80516001600160a01b0381168114620002a6575f80fd5b919050565b5f805f805f805f80610100898b031215620002c4575f80fd5b88516001600160401b0380821115620002db575f80fd5b620002e98c838d0162000201565b995060208b015198506200030060408c016200028f565b975060608b0151965060808b01519150808211156200031d575f80fd5b6200032b8c838d0162000201565b955060a08b015191508082111562000341575f80fd5b6200034f8c838d0162000201565b945060c08b015191508082111562000365575f80fd5b620003738c838d0162000201565b935060e08b015191508082111562000389575f80fd5b50620003988b828c0162000201565b9150509295985092959890939650565b600181811c90821680620003bd57607f821691505b602082108103620003dc57634e487b7160e01b5f52602260045260245ffd5b50919050565b601f8211156200042d57805f5260205f20601f840160051c81016020851015620004095750805b601f840160051c820191505b818110156200042a575f815560010162000415565b50505b505050565b81516001600160401b038111156200044e576200044e620001c9565b62000466816200045f8454620003a8565b84620003e2565b602080601f8311600181146200049c575f8415620004845750858301515b5f19600386901b1c1916600185901b178555620004f6565b5f85815260208120601f198616915b82811015620004cc57888601518255948401946001909101908401620004ab565b5085821015620004ea57878501515f19600388901b60f8161c191681555b505060018460011b0185555b505050505050565b5f815180845262000517816020860160208601620001dd565b601f01601f19169290920160200192915050565b60a081525f6200053f60a0830188620004fe565b8281036020840152620005538188620004fe565b60ff969096166040840152505060608101929092526001600160a01b031660809091015292915050565b60805160a05160c051611892620005f55f395f818161034a015281816105060152818161054e015281816105a90152818161089601526108d301525f818161023801528181610a7701528181610e72015261112201525f81816104a901528181610a9d01528181610dc1015261108c01526118925ff3fe60806040526004361061017e575f3560e01c80637dc0d1d0116100cd578063be040fb011610087578063e8078d9411610062578063e8078d9414610490578063f0d9bb2014610498578063f2fde38b146104cb578063f3e41e90146104ea575f80fd5b8063be040fb01461044a578063de2546591461045e578063e24c469b1461047d575f80fd5b80637dc0d1d01461039f5780638779086f146103be5780638da5cb5b146103d25780639860f1a7146103ee578063a4d750651461040d578063b44f77c11461042c575f80fd5b806327c7ff61116101385780634ac8eb5f116101135780634ac8eb5f146103245780634df7e3d014610339578063715018a61461036c5780637adbf97314610380575f80fd5b806327c7ff61146102c55780633f6fa655146102da5780633fad9ae014610303575f80fd5b806309604403146101d45780630bede3f81461020657806311a9f10a1461022757806312b01b161461027257806316953f021461028657806323341a051461029b575f80fd5b366101d0573460075f82825461019491906115d2565b909155505060405134815233907fc17cea59c2955cb181b03393209566960365771dbba9dc3d510180e7cb3120889060200160405180910390a2005b5f80fd5b3480156101df575f80fd5b506101f36101ee3660046115e5565b6104ff565b6040519081526020015b60405180910390f35b348015610211575f80fd5b50610225610220366004611612565b6105e4565b005b348015610232575f80fd5b5061025a7f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b0390911681526020016101fd565b34801561027d575f80fd5b506101f36106ad565b348015610291575f80fd5b506101f360045481565b3480156102a6575f80fd5b506102af6106cd565b6040516101fd9a99989796959493929190611677565b3480156102d0575f80fd5b506101f360055481565b3480156102e5575f80fd5b506006546102f39060ff1681565b60405190151581526020016101fd565b34801561030e575f80fd5b506103176107c6565b6040516101fd91906116dd565b34801561032f575f80fd5b506101f360075481565b348015610344575f80fd5b506101f37f000000000000000000000000000000000000000000000000000000000000000081565b348015610377575f80fd5b50610225610852565b34801561038b575f80fd5b5061022561039a3660046116ef565b610865565b3480156103aa575f80fd5b5060035461025a906001600160a01b031681565b3480156103c9575f80fd5b506101f361088f565b3480156103dd575f80fd5b505f546001600160a01b031661025a565b3480156103f9575f80fd5b506101f3610408366004611715565b610937565b348015610418575f80fd5b506101f3610427366004611715565b6109df565b348015610437575f80fd5b506006546102f390610100900460ff1681565b348015610455575f80fd5b50610225610a39565b348015610469575f80fd5b5061022561047836600461173f565b610d10565b61022561048b366004611715565b610fda565b6102256111f7565b3480156104a3575f80fd5b5061025a7f000000000000000000000000000000000000000000000000000000000000000081565b3480156104d6575f80fd5b506102256104e53660046116ef565b611264565b3480156104f5575f80fd5b506101f360025481565b5f806105467f000000000000000000000000000000000000000000000000000000000000000061053786670de0b6b3a7640000611771565b6105419190611788565b6112a6565b90505f61057f7f000000000000000000000000000000000000000000000000000000000000000061053786670de0b6b3a7640000611771565b90505f61058c82846115d2565b90505f6105988261132f565b9050670de0b6b3a76400006105cd827f0000000000000000000000000000000000000000000000000000000000000000611771565b6105d79190611788565b9450505050505b92915050565b6003546001600160a01b0316331461060f57604051631bc2178f60e01b815260040160405180910390fd5b60065460ff16156106335760405163aa43cb2d60e01b815260040160405180910390fd5b60025442101561065657604051633c04f06b60e01b815260040160405180910390fd5b600680548215156101000261ffff199091161760011790556040517ff528f3b02f5c2503827fc677c9d0cb54ffbf11ed32cb659f73243b70dea7cf0e906106a290831515815260200190565b60405180910390a150565b5f6106b661088f565b6106c890670de0b6b3a76400006117a7565b905090565b60605f805f805f805f805f600160025460035f9054906101000a90046001600160a01b03166106fa61088f565b6107026106ad565b600454600554600754600654885460ff80831692610100900416908a90610728906117ba565b80601f0160208091040260200160405190810160405280929190818152602001828054610754906117ba565b801561079f5780601f106107765761010080835404028352916020019161079f565b820191905f5260205f20905b81548152906001019060200180831161078257829003601f168201915b50505050509950995099509950995099509950995099509950995090919293949596979899565b600180546107d3906117ba565b80601f01602080910402602001604051908101604052809291908181526020018280546107ff906117ba565b801561084a5780601f106108215761010080835404028352916020019161084a565b820191905f5260205f20905b81548152906001019060200180831161082d57829003601f168201915b505050505081565b61085a61147a565b6108635f6114a6565b565b61086d61147a565b600380546001600160a01b0319166001600160a01b0392909216919091179055565b5f806108cb7f0000000000000000000000000000000000000000000000000000000000000000600454670de0b6b3a76400006105379190611771565b90505f6109087f0000000000000000000000000000000000000000000000000000000000000000600554670de0b6b3a76400006105379190611771565b905061091481836115d2565b61092683670de0b6b3a7640000611771565b6109309190611788565b9250505090565b5f828015610946575060045482115b1561095257505f6105de565b82158015610961575060055482115b1561096d57505f6105de565b5f8361097b57600454610989565b8260045461098991906117a7565b90505f846109a4578360055461099f91906117a7565b6109a8565b6005545b90505f6109b96004546005546104ff565b90505f6109c684846104ff565b90508082116109d5575f6105d7565b6105d781836117a7565b5f80836109ee576004546109fc565b826004546109fc91906115d2565b90505f84610a175783600554610a1291906115d2565b610a1b565b6005545b90505f610a2883836104ff565b90505f6109c66004546005546104ff565b610a416114f5565b60065460ff16610a645760405163174b639360e11b815260040160405180910390fd5b6006545f90610100900460ff16610a9b577f0000000000000000000000000000000000000000000000000000000000000000610abd565b7f00000000000000000000000000000000000000000000000000000000000000005b6040516370a0823160e01b81523360048201529091505f906001600160a01b038316906370a0823190602401602060405180830381865afa158015610b04573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610b2891906117f2565b9050805f03610b4a5760405163162908e360e11b815260040160405180910390fd5b6040516323b872dd60e01b8152336004820152306024820152604481018290526001600160a01b038316906323b872dd906064016020604051808303815f875af1158015610b9a573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610bbe9190611809565b506006545f90610100900460ff16610bd857600554610bdc565b6004545b90505f8160075484610bee9190611771565b610bf89190611788565b600654909150610100900460ff1615610c27578260045f828254610c1c91906117a7565b90915550610c3e9050565b8260055f828254610c3891906117a7565b90915550505b8060075f828254610c4f91906117a7565b90915550506040515f90339083908381818185875af1925050503d805f8114610c93576040519150601f19603f3d011682016040523d82523d5f602084013e610c98565b606091505b5050905080610cba576040516312171d8360e31b815260040160405180910390fd5b604080518581526020810184905233917ff3a670cd3af7d64b488926880889d08a8585a138ff455227af6737339a1ec262910160405180910390a2505050505061086360015f8051602061183d83398151915255565b610d186114f5565b60065460ff1615610d3c5760405163aa43cb2d60e01b815260040160405180910390fd5b815f03610d5c5760405163162908e360e11b815260040160405180910390fd5b5f610d678484610937565b905081811015610d8a5760405163cd1c886760e01b815260040160405180910390fd5b600754811115610d9957506007545b8315610e50576040516323b872dd60e01b8152336004820152306024820152604481018490527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906323b872dd906064016020604051808303815f875af1158015610e0f573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610e339190611809565b508260045f828254610e4591906117a7565b90915550610efc9050565b6040516323b872dd60e01b8152336004820152306024820152604481018490527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906323b872dd906064016020604051808303815f875af1158015610ec0573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610ee49190611809565b508260055f828254610ef691906117a7565b90915550505b8060075f828254610f0d91906117a7565b90915550506040515f90339083908381818185875af1925050503d805f8114610f51576040519150601f19603f3d011682016040523d82523d5f602084013e610f56565b606091505b5050905080610f78576040516312171d8360e31b815260040160405180910390fd5b6040805186151581526020810186905290810183905233907fcf06b88583ec57d4cf2f6795931fe9057d95a86052efc8d8b3a4cad0e885d5e99060600160405180910390a25050610fd560015f8051602061183d83398151915255565b505050565b610fe26114f5565b60065460ff16156110065760405163aa43cb2d60e01b815260040160405180910390fd5b345f036110265760405163cd1c886760e01b815260040160405180910390fd5b5f6110318334611510565b9050818110156110545760405163cd1c886760e01b815260040160405180910390fd5b82156110f0578060045f82825461106b91906115d2565b90915550506040516340c10f1960e01b8152336004820152602481018290527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906340c10f19906044015f604051808303815f87803b1580156110d5575f80fd5b505af11580156110e7573d5f803e3d5ffd5b50505050611182565b8060055f82825461110191906115d2565b90915550506040516340c10f1960e01b8152336004820152602481018290527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906340c10f19906044015f604051808303815f87803b15801561116b575f80fd5b505af115801561117d573d5f803e3d5ffd5b505050505b3460075f82825461119391906115d2565b9091555050604080518415158152602081018390523481830152905133917f9bd054fb950acb82b978a4ba93668286e2c3fa8c43589f21061c8520068ba80c919081900360600190a2506111f360015f8051602061183d83398151915255565b5050565b345f036112175760405163162908e360e11b815260040160405180910390fd5b3460075f82825461122891906115d2565b909155505060405134815233907fc17cea59c2955cb181b03393209566960365771dbba9dc3d510180e7cb3120889060200160405180910390a2565b61126c61147a565b6001600160a01b03811661129a57604051631e4fbdf760e01b81525f60048201526024015b60405180910390fd5b6112a3816114a6565b50565b5f6753444835ec5800008211156112c3576753444835ec58000091505b670de0b6b3a76400008060015b600c8111611326576112ea81670de0b6b3a7640000611771565b6112f48684611771565b6112fe9190611788565b915061130a82846115d2565b925060018210611326578061131e81611824565b9150506112d0565b50909392505050565b5f670de0b6b3a764000082101561134757505f919050565b81670de0b6b3a76400000361135d57505f919050565b67099e8db03256ce5d5f5b671bc16d674ec80000841061139657611382600285611788565b93508061138e81611824565b915050611368565b5f6113a9670de0b6b3a7640000866117a7565b9050805f036113c5576113bc8383611771565b95945050505050565b5f816001805b601e81116114595781156113f4576113e38184611788565b6113ed90856115d2565b935061141b565b836113ff8285611788565b116114595761140e8184611788565b61141890856117a7565b93505b670de0b6b3a764000061142e8685611771565b6114389190611788565b9250901590620f42408310611459578061145181611824565b9150506113cb565b506114648686611771565b61146e90846115d2565b98975050505050505050565b5f546001600160a01b031633146108635760405163118cdaa760e01b8152336004820152602401611291565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b6114fd61158f565b60025f8051602061183d83398151915255565b5f808061151e846002611771565b90505f805b604081101561158457600261153884866115d2565b6115429190611788565b91505f61154f88846109df565b905086811161156057829450611564565b8293505b600161157086866117a7565b1161157b5750611584565b50600101611523565b509195945050505050565b5f8051602061183d8339815191525460020361086357604051633ee5aeb560e01b815260040160405180910390fd5b634e487b7160e01b5f52601160045260245ffd5b808201808211156105de576105de6115be565b5f80604083850312156115f6575f80fd5b50508035926020909101359150565b80151581146112a3575f80fd5b5f60208284031215611622575f80fd5b813561162d81611605565b9392505050565b5f81518084525f5b818110156116585760208185018101518683018201520161163c565b505f602082860101526020601f19601f83011685010191505092915050565b5f61014080835261168a8184018e611634565b602084019c909c5250506001600160a01b039890981660408901526060880196909652608087019490945260a086019290925260c085015260e08401521515610100830152151561012090910152919050565b602081525f61162d6020830184611634565b5f602082840312156116ff575f80fd5b81356001600160a01b038116811461162d575f80fd5b5f8060408385031215611726575f80fd5b823561173181611605565b946020939093013593505050565b5f805f60608486031215611751575f80fd5b833561175c81611605565b95602085013595506040909401359392505050565b80820281158282048414176105de576105de6115be565b5f826117a257634e487b7160e01b5f52601260045260245ffd5b500490565b818103818111156105de576105de6115be565b600181811c908216806117ce57607f821691505b6020821081036117ec57634e487b7160e01b5f52602260045260245ffd5b50919050565b5f60208284031215611802575f80fd5b5051919050565b5f60208284031215611819575f80fd5b815161162d81611605565b5f60018201611835576118356115be565b506001019056fe9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f00a26469706673582212200b71eb8b70d23f713fd44ce3892cc58f1def09a2287203da44238c035716fa8e64736f6c6343000818003360a060405234801562000010575f80fd5b5060405162000ea538038062000ea583398101604081905262000033916200032c565b80858560036200004483826200045e565b5060046200005382826200045e565b5050506001600160a01b0381166200008557604051631e4fbdf760e01b81525f60048201526024015b60405180910390fd5b6200009081620000af565b5060ff8316608052620000a4818362000100565b505050505062000550565b600580546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0905f90a35050565b6001600160a01b0382166200012b5760405163ec442f0560e01b81525f60048201526024016200007c565b620001385f83836200013c565b5050565b6001600160a01b0383166200016a578060025f8282546200015e91906200052a565b90915550620001dc9050565b6001600160a01b0383165f9081526020819052604090205481811015620001be5760405163391434e360e21b81526001600160a01b038516600482015260248101829052604481018390526064016200007c565b6001600160a01b0384165f9081526020819052604090209082900390555b6001600160a01b038216620001fa5760028054829003905562000218565b6001600160a01b0382165f9081526020819052604090208054820190555b816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516200025e91815260200190565b60405180910390a3505050565b634e487b7160e01b5f52604160045260245ffd5b5f82601f8301126200028f575f80fd5b81516001600160401b0380821115620002ac57620002ac6200026b565b604051601f8301601f19908116603f01168101908282118183101715620002d757620002d76200026b565b8160405283815260209250866020858801011115620002f4575f80fd5b5f91505b83821015620003175785820183015181830184015290820190620002f8565b5f602085830101528094505050505092915050565b5f805f805f60a0868803121562000341575f80fd5b85516001600160401b038082111562000358575f80fd5b6200036689838a016200027f565b965060208801519150808211156200037c575f80fd5b506200038b888289016200027f565b945050604086015160ff81168114620003a2575f80fd5b6060870151608088015191945092506001600160a01b0381168114620003c6575f80fd5b809150509295509295909350565b600181811c90821680620003e957607f821691505b6020821081036200040857634e487b7160e01b5f52602260045260245ffd5b50919050565b601f8211156200045957805f5260205f20601f840160051c81016020851015620004355750805b601f840160051c820191505b8181101562000456575f815560010162000441565b50505b505050565b81516001600160401b038111156200047a576200047a6200026b565b62000492816200048b8454620003d4565b846200040e565b602080601f831160018114620004c8575f8415620004b05750858301515b5f19600386901b1c1916600185901b17855562000522565b5f85815260208120601f198616915b82811015620004f857888601518255948401946001909101908401620004d7565b50858210156200051657878501515f19600388901b60f8161c191681555b505060018460011b0185555b505050505050565b808201808211156200054a57634e487b7160e01b5f52601160045260245ffd5b92915050565b60805161093c620005695f395f610156015261093c5ff3fe608060405234801561000f575f80fd5b50600436106100e5575f3560e01c806370a082311161008857806395d89b411161006357806395d89b41146101f3578063a9059cbb146101fb578063dd62ed3e1461020e578063f2fde38b14610246575f80fd5b806370a08231146101a8578063715018a6146101d05780638da5cb5b146101d8575f80fd5b806323b872dd116100c357806323b872dd1461013c578063313ce5671461014f57806340c10f191461018057806342966c6814610195575f80fd5b806306fdde03146100e9578063095ea7b31461010757806318160ddd1461012a575b5f80fd5b6100f1610259565b6040516100fe919061077f565b60405180910390f35b61011a6101153660046107e6565b6102e9565b60405190151581526020016100fe565b6002545b6040519081526020016100fe565b61011a61014a36600461080e565b610302565b60405160ff7f00000000000000000000000000000000000000000000000000000000000000001681526020016100fe565b61019361018e3660046107e6565b610325565b005b6101936101a3366004610847565b61033b565b61012e6101b636600461085e565b6001600160a01b03165f9081526020819052604090205490565b610193610348565b6005546040516001600160a01b0390911681526020016100fe565b6100f161035b565b61011a6102093660046107e6565b61036a565b61012e61021c36600461087e565b6001600160a01b039182165f90815260016020908152604080832093909416825291909152205490565b61019361025436600461085e565b610377565b606060038054610268906108af565b80601f0160208091040260200160405190810160405280929190818152602001828054610294906108af565b80156102df5780601f106102b6576101008083540402835291602001916102df565b820191905f5260205f20905b8154815290600101906020018083116102c257829003601f168201915b5050505050905090565b5f336102f68185856103b6565b60019150505b92915050565b5f3361030f8582856103c8565b61031a858585610444565b506001949350505050565b61032d6104a1565b61033782826104ce565b5050565b6103453382610502565b50565b6103506104a1565b6103595f610536565b565b606060048054610268906108af565b5f336102f6818585610444565b61037f6104a1565b6001600160a01b0381166103ad57604051631e4fbdf760e01b81525f60048201526024015b60405180910390fd5b61034581610536565b6103c38383836001610587565b505050565b6001600160a01b038381165f908152600160209081526040808320938616835292905220545f1981101561043e578181101561043057604051637dc7a0d960e11b81526001600160a01b038416600482015260248101829052604481018390526064016103a4565b61043e84848484035f610587565b50505050565b6001600160a01b03831661046d57604051634b637e8f60e11b81525f60048201526024016103a4565b6001600160a01b0382166104965760405163ec442f0560e01b81525f60048201526024016103a4565b6103c3838383610659565b6005546001600160a01b031633146103595760405163118cdaa760e01b81523360048201526024016103a4565b6001600160a01b0382166104f75760405163ec442f0560e01b81525f60048201526024016103a4565b6103375f8383610659565b6001600160a01b03821661052b57604051634b637e8f60e11b81525f60048201526024016103a4565b610337825f83610659565b600580546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0905f90a35050565b6001600160a01b0384166105b05760405163e602df0560e01b81525f60048201526024016103a4565b6001600160a01b0383166105d957604051634a1406b160e11b81525f60048201526024016103a4565b6001600160a01b038085165f908152600160209081526040808320938716835292905220829055801561043e57826001600160a01b0316846001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9258460405161064b91815260200190565b60405180910390a350505050565b6001600160a01b038316610683578060025f82825461067891906108e7565b909155506106f39050565b6001600160a01b0383165f90815260208190526040902054818110156106d55760405163391434e360e21b81526001600160a01b038516600482015260248101829052604481018390526064016103a4565b6001600160a01b0384165f9081526020819052604090209082900390555b6001600160a01b03821661070f5760028054829003905561072d565b6001600160a01b0382165f9081526020819052604090208054820190555b816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8360405161077291815260200190565b60405180910390a3505050565b5f602080835283518060208501525f5b818110156107ab5785810183015185820160400152820161078f565b505f604082860101526040601f19601f8301168501019250505092915050565b80356001600160a01b03811681146107e1575f80fd5b919050565b5f80604083850312156107f7575f80fd5b610800836107cb565b946020939093013593505050565b5f805f60608486031215610820575f80fd5b610829846107cb565b9250610837602085016107cb565b9150604084013590509250925092565b5f60208284031215610857575f80fd5b5035919050565b5f6020828403121561086e575f80fd5b610877826107cb565b9392505050565b5f806040838503121561088f575f80fd5b610898836107cb565b91506108a6602084016107cb565b90509250929050565b600181811c908216806108c357607f821691505b6020821081036108e157634e487b7160e01b5f52602260045260245ffd5b50919050565b808201808211156102fc57634e487b7160e01b5f52601160045260245ffdfea264697066735822122016c9be8f982c06a57ff825f2ca65cbb1a39fd2f8a690f9ee0cceda68219e85df64736f6c63430008180033' as const;

// LS-LMSR bytecode (compiled from contracts/LSLMSR.sol with via_ir=true)
const LSLMSR_BYTECODE = '0x6040610100815234620004375762002e1a803803806200001f816200043b565b928339810161016082820312620004375781516001600160401b0391908281116200043757816200005291850162000484565b602080850151868601516001600160a01b03969195919390878116908190036200043757606085015160808601519160a08701519860c08801519a60e089015187811162000437578a620000a8918b0162000484565b976101008a015188811162000437578b620000c5918c0162000484565b9961012081015189811162000437578c620000e291830162000484565b9b6101408201518a81116200043757620000fd920162000484565b9633156200042057908e9392915f5460018060a01b03199533878316175f5551933391167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e05f80a3600192837f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055871562000411575042841115620003f5578515620003f5578d158f811562000407575b50620003f5578051918a8311620002ee578354918483811c93168015620003ea575b82841014620003d65782601f8594116200037f575b5081601f84116001146200031857505f926200030c575b50505f19600383901b1c191690821b1790555b600255600354161760035560c05260e0528751610e2f948582019082821085831117620002ee5782916200022e9162001feb9789898639309262000502565b03905ff08015620003025760805287519484860192831186841017620002ee5785946200025f948639309262000502565b03905ff08015620002e45760a05260045560055551611a9d90816200054e82396080518181816102a5015281816103ba015281816106db0152610a1b015260a0518181816105020152818161083701528181610c4e015261117f015260c05181818161096b0152611469015260e0518181816110140152818161149101526115b50152f35b83513d5f823e3d90fd5b634e487b7160e01b5f52604160045260245ffd5b88513d5f823e3d90fd5b015190505f80620001dc565b9190859450601f198416855f52835f20935f905b8282106200036557505084116200034c575b505050811b019055620001ef565b01515f1960f88460031b161c191690555f80806200033e565b84840151865588979095019493840193908101906200032c565b90919250845f52825f20601f850160051c810191848610620003cb575b8594939291601f88920160051c01915b828110620003bc575050620001c5565b5f8155869550879101620003ac565b90915081906200039c565b634e487b7160e01b5f52602260045260245ffd5b92607f1692620001b0565b508e51630e52390960e41b8152600490fd5b9050158f6200018e565b630e52390960e41b8152600490fd5b8e51631e4fbdf760e01b81525f6004820152602490fd5b5f80fd5b6040519190601f01601f191682016001600160401b03811183821017620002ee57604052565b5f5b838110620004735750505f910152565b818101518382015260200162000463565b81601f82011215620004375780516001600160401b038111620002ee57620004b6601f8201601f19166020016200043b565b92818452602082840101116200043757620004d8916020808501910162000461565b90565b90602091620004f68151809281855285808601910162000461565b601f01601f1916010190565b9162000530906200052160809396959660a0865260a0860190620004db565b908482036020860152620004db565b601260408401525f60608401526001600160a01b0390941691015256fe604060808152600480361015610056575b50361561001b575f80fd5b610027346007546113fc565b600755513481527fc17cea59c2955cb181b03393209566960365771dbba9dc3d510180e7cb31208860203392a2005b5f905f3560e01c908163096044031461125e5781630bede3f8146111ae57816311a9f10a1461116b57816312b01b161461114f57816316953f021461113357816323341a0514611037578163252cf2d214610ffd57816327c7ff6114610fdf5781633a69a1be14610fc35781633f4ba83a14610f565781633f6fa65514610f335781633fad9ae014610eff5781634ac8eb5f14610ee15781635c975abb14610ebc5781635dafcd5914610ea0578163715018a614610e495781637adbf97314610dc15781637dc0d1d014610d995781638456cb5914610d3b5781638779086f14610d1f5781638da5cb5b14610cf85781639860f1a714610cd0578163a4d7506514610ca8578163b44f77c114610c82578163be040fb0146109e8578163ccb26f0f146109c3578163cdd421481461098e578163db1d0fd514610953578163de2546591461062a578163e24c469b14610333578163e8078d94146102d4578163f0d9bb2014610290578163f2fde38b146101f6575063f3e41e90036100105790346101f257816003193601126101f2576020906002549051908152f35b5080fd5b9050823461028c57602036600319011261028c576001600160a01b038235818116939192908490036102885761022a6119da565b83156102725750505f54826bffffffffffffffffffffffff60a01b8216175f55167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e05f80a380f35b51631e4fbdf760e01b8152908101849052602490fd5b8480fd5b8280fd5b8284346101f257816003193601126101f257517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b8391508260031936011261028c57341561032557506102f5346007546113fc565b600755513481527fc17cea59c2955cb181b03393209566960365771dbba9dc3d510180e7cb31208860203392a280f35b905163162908e360e11b8152fd5b8380925060031936011261028c5761034961127f565b91610352611a05565b61035a611a47565b60ff6006541661061d5734156106105783906001600160ff1b033411156105ed575f195b855b8281106105a3575b50506024358210610594578115610585576103a3828561175c565b9284156104f0576103b58382546113fc565b8155857f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316803b156101f25783516340c10f1960e01b815233848201908152602081018790529091839183919082908490829060400103925af180156104e6576104ce575b50505b610431846007546113fc565b6007558334116104a1575b505192151583526020830152604082015233907f9bd054fb950acb82b978a4ba93668286e2c3fa8c43589f21061c8520068ba80c9080606081015b0390a260017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f005580f35b858080806104af88346116a4565b335af16104ba6117c5565b5061043c575b90516312171d8360e31b8152fd5b6104d7906112cc565b6104e2578587610422565b8580fd5b84513d84823e3d90fd5b6104fc836005546113fc565b600555857f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316803b156101f25783516340c10f1960e01b815233848201908152602081018790529091839183919082908490829060400103925af180156104e657610571575b5050610425565b61057a906112cc565b6104e257858761056a565b5163162908e360e11b81529050fd5b5163cd1c886760e01b81529050fd5b6105ad82856113fc565b93600194851c90346105bf838a61175c565b116105e45750935b6105d185846116a4565b11156105df57600101610380565b610388565b949250916105c7565b3460011b3481046002031561037e575b634e487b7160e01b865260118452602486fd5b5163cd1c886760e01b8152fd5b5163aa43cb2d60e01b8152fd5b8391503461028c57606036600319011261028c5761064661127f565b9160243590610653611a05565b61065b611a47565b60ff60065416610944578115610585578315610918578254670de0b6b3a763ffff1981019081116105fd578211610909575b61069782856116b1565b9260443584106108fb576007548085116108f3575b50841561080f5781516323b872dd60e01b815233828201908152306020828101919091526040820186905288927f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03169290919082908190606001038186865af18015610805576107d6575b50803b156101f2578180916024865180948193630852cd8d60e31b83528a898401525af180156104e6576107c2575b505061075b8382546116a4565b81555b61076a846007546116a4565b6007558580808087335af161077d6117c5565b50156104c057505192151583526020830152604082015233907fcf06b88583ec57d4cf2f6795931fe9057d95a86052efc8d8b3a4cad0e885d5e9908060608101610477565b6107cb906112cc565b6104e257858761074e565b6107f79060203d6020116107fe575b6107ef81836112f4565b8101906117ad565b508861071f565b503d6107e5565b85513d85823e3d90fd5b81516323b872dd60e01b815233828201908152306020828101919091526040820186905288927f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03169290919082908190606001038186865af18015610805576108d4575b50803b156101f2578180916024865180948193630852cd8d60e31b83528a898401525af180156104e6576108c0575b50506108b8836005546116a4565b60055561075e565b6108c9906112cc565b6104e25785876108aa565b6108ec9060203d6020116107fe576107ef81836112f4565b508861087b565b9350866106ac565b905163cd1c886760e01b8152fd5b51633999656760e01b81529050fd5b600554670de0b6b3a763ffff1981019081116105fd5782111561068d5751633999656760e01b81529050fd5b5163aa43cb2d60e01b81529050fd5b8284346101f257816003193601126101f257602090517f00000000000000000000000000000000000000000000000000000000000000008152f35b8284346101f257816003193601126101f2576020906109bc6109ae61161b565b6109b661151b565b906113fc565b9051908152f35b8284346101f257816003193601126101f2576020906109bc6109e36115e5565b61168e565b828434610be2575f366003190112610be257610a02611a05565b60065460ff811615610c725760081c60ff1615610c4c577f00000000000000000000000000000000000000000000000000000000000000005b81516370a0823160e01b8152338582015291906020906001600160a01b03168184602481845afa938415610bd8575f94610c1d575b508315610c0d5782516323b872dd60e01b8152338782019081523060208201526040810186905283908290819060600103815f865af18015610c0357610be6575b50803b15610be2575f80916024855180948193630852cd8d60e31b8352898c8401525af18015610bd857610bc5575b5060065460081c60ff16908115610bba57610b0886545b610b036007548761141d565b611430565b9115610ba657610b198487546116a4565b86555b610b28826007546116a4565b6007558480808085335af1610b3b6117c5565b5015610b9657825193845283015233917ff3a670cd3af7d64b488926880889d08a8585a138ff455227af6737339a1ec2629190a260017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f005580f35b82516312171d8360e31b81528690fd5b610bb2846005546116a4565b600555610b1c565b610b08600554610af7565b610bd09194506112cc565b5f9285610ae0565b83513d5f823e3d90fd5b5f80fd5b610bfc90833d85116107fe576107ef81836112f4565b5086610ab1565b84513d5f823e3d90fd5b825163162908e360e11b81528690fd5b9093508181813d8311610c45575b610c3581836112f4565b81010312610be257519286610a70565b503d610c2b565b7f0000000000000000000000000000000000000000000000000000000000000000610a3b565b815163174b639360e11b81528490fd5b8334610be2575f366003190112610be25760209060ff60065460081c1690519015158152f35b8334610be25780600319360112610be2576020906109bc610cc761127f565b6024359061175c565b8334610be25780600319360112610be2576020906109bc610cef61127f565b602435906116b1565b8334610be2575f366003190112610be2575f5490516001600160a01b039091168152602090f35b8334610be2575f366003190112610be2576020906109bc61161b565b8334610be2575f366003190112610be25760207f62e78cea01bee320cd4e420270b5ea74000d11b0c9f74754ebdbfc544b05a25891610d786119da565b610d80611a47565b5f805460ff60a01b1916600160a01b17905551338152a1005b8334610be2575f366003190112610be25760035490516001600160a01b039091168152602090f35b8334610be2576020366003190112610be2576001600160a01b03823581811693919290849003610be257610df36119da565b8315610e3c575050600354826bffffffffffffffffffffffff60a01b821617600355167f05cd89403c6bdeac21c2ff33de395121a31fa1bc2bf3adf4825f1f86e79969dd5f80a3005b51630e52390960e41b8152fd5b34610be2575f366003190112610be257610e616119da565b5f80546001600160a01b0319811682556001600160a01b03167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08280a3005b8334610be2575f366003190112610be2576020906109bc6115e5565b8334610be2575f366003190112610be25760209060ff5f5460a01c1690519015158152f35b8334610be2575f366003190112610be2576020906007549051908152f35b8334610be2575f366003190112610be257610f2f90610f1c611316565b905191829160208352602083019061128e565b0390f35b8334610be2575f366003190112610be25760209060ff6006541690519015158152f35b8334610be2575f366003190112610be257610f6f6119da565b5f549160ff8360a01c1615610fb55760ff60a01b1983165f5581513381527f5db9ee0a495bf2e6ff9c91a7834c1ba4fdd244a5e8aa4e537bd38aeae4b073aa90602090a1005b9051638dfc202b60e01b8152fd5b8334610be2575f366003190112610be2576020906109bc611597565b8334610be2575f366003190112610be2576020906005549051908152f35b8334610be2575f366003190112610be257602090517f00000000000000000000000000000000000000000000000000000000000000008152f35b839034610be2575f366003190112610be25760025460035490916001600160a01b039091169061106561161b565b9061106e61151b565b906110776115e5565b906110806115e5565b6110899061168e565b9054600554906007549261109b611597565b946110a461161b565b6110ac61151b565b6110b5916113fc565b96600654986110c2611316565b9a8d519d8e9d8e9d8e6101c090818152016110dc9161128e565b9d602001528d015260608c015260808b015260a08a015260c089015260e088015261010087015261012086015261014085015261016084015260ff8116151561018084015260081c60ff1615156101a08301520390f35b8334610be2575f366003190112610be257602091549051908152f35b8334610be2575f366003190112610be2576020906109bc61151b565b8334610be2575f366003190112610be257517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b8334610be2576020366003190112610be2576111c861127f565b6003546001600160a01b03163303611250576006549260ff8416611242576002544210611234577ff528f3b02f5c2503827fc677c9d0cb54ffbf11ed32cb659f73243b70dea7cf0e6020858560018615159261ff008460081b169061ffff1916171760065551908152a1005b8251633c04f06b60e01b8152fd5b825163aa43cb2d60e01b8152fd5b5051631bc2178f60e01b8152fd5b8334610be25780600319360112610be2576109bc602092602435903561144e565b600435908115158203610be257565b91908251928382525f5b8481106112b8575050825f602080949584010152601f8019910116010190565b602081830181015184830182015201611298565b67ffffffffffffffff81116112e057604052565b634e487b7160e01b5f52604160045260245ffd5b90601f8019910116810190811067ffffffffffffffff8211176112e057604052565b604051905f60018054918260011c600184169283156113f2575b60209485831085146113de5782885287949081156113be5750600114611361575b505061135f925003836112f4565b565b9093915060015f527fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6935f915b8183106113a657505061135f93508201015f80611351565b8554888401850152948501948794509183019161138e565b91505061135f94925060ff191682840152151560051b8201015f80611351565b634e487b7160e01b5f52602260045260245ffd5b90607f1690611330565b9190820180921161140957565b634e487b7160e01b5f52601160045260245ffd5b8181029291811591840414171561140957565b811561143a570490565b634e487b7160e01b5f52601260045260245ffd5b90670de0b6b3a7640000918261148d61146784846113fc565b7f000000000000000000000000000000000000000000000000000000000000000061141d565b04907f0000000000000000000000000000000000000000000000000000000000000000808310611513575b5083810290808204851490151715611409576114d7826114dc92611430565b611812565b8383029280840485149015171561140957611504611509916109b66114d78561150f97611430565b6118ad565b9061141d565b0490565b91505f6114b8565b611523611597565b600454670de0b6b3a76400009081810290808204831490151715611409576114d78361154e92611430565b916005548281029080820484149015171561140957611570916114d791611430565b91818302918383041483151715611409576115949261158e916113fc565b90611430565b90565b670de0b6b3a76400006115b2611467600454600554906113fc565b047f0000000000000000000000000000000000000000000000000000000000000000808211156115e0575090565b905090565b6115ed61161b565b6115f86109ae61161b565b670de0b6b3a7640000918281029281840414901517156114095761159491611430565b611623611597565b600454670de0b6b3a76400009081810290808204831490151715611409576114d78361164e92611430565b916005548281029080820484149015171561140957611670916114d791611430565b91818102918183041481151715611409576115949261158e916113fc565b90670de0b6b3a764000091820391821161140957565b9190820391821161140957565b908180611751575b61171e57811580611746575b61171e57811561173d576116db816004546116a4565b915b1561172c57506005545b81158015611724575b61171e5761170d906117076004546005549061144e565b9261144e565b8082111561171e57611594916116a4565b50505f90565b5080156116f0565b611738906005546116a4565b6116e7565b600454916116dd565b5060055481116116c5565b5060045481116116b9565b6117839181156117a457611772816004546113fc565b915b1561179257506005549061144e565b61170d6004546005549061144e565b61179e906005546113fc565b9061144e565b60045491611774565b90816020910312610be257518015158103610be25790565b3d156117ff573d9067ffffffffffffffff82116112e057604051916117f4601f8201601f1916602001846112f4565b82523d5f602084013e565b606090565b5f1981146114095760010190565b6753444835ec5800008082116118a5575b50670de0b6b3a7640000906001908190835b600c841115611846575b5050505090565b816118509161141d565b670de0b6b3a7640000840290848204670de0b6b3a76400001485151715611409576118859161187e91611430565b80956113fc565b9282851061189d5761189690611804565b9293611835565b83945061183f565b90505f611823565b670de0b6b3a76400009081811061171e5781811461171e575f905b671bc16d674ec800008110156119c757670de0b6b3a763ffff1981019081116114095780156119a9575f92819060019081905b601e82111561192d575b505050505067099e8db03256ce5d9081810291818304149015171561140957611594916113fc565b90919293958185855f146119785761194d61195392936109b6878c611430565b9861141d565b04921591620f424084106119735761196a90611804565b909392936118fb565b611905565b5050806119858489611430565b116119a3576119538561194d849361199d878c611430565b906116a4565b95611905565b5067099e8db03256ce5d808202925081159183041417156114095790565b6119d49060011c91611804565b906118c8565b5f546001600160a01b031633036119ed57565b60405163118cdaa760e01b8152336004820152602490fd5b7f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f006002815414611a355760029055565b604051633ee5aeb560e01b8152600490fd5b60ff5f5460a01c16611a5557565b60405163d93c066560e01b8152600490fdfea2646970667358221220270b5ecd2143477906700b856d0d30aad4500c055599c57f8e7432049bd459f364736f6c63430008180033604060a0815234620003fb5762000e2f803803806200001e81620003ff565b928339810160a082820312620003fb5781516001600160401b039290838111620003fb57826200005091830162000425565b926020928383015190828211620003fb576200006e91840162000425565b90858301519060ff82168203620003fb57608060608501519401519560018060a01b0391828816809803620003fb57815181811162000301576003908154906001948583811c93168015620003f0575b8b841014620003dc5781908b601f9485811162000386575b50508b9084831160011462000321575f9262000315575b50505f1982851b1c191690851b1782555b8651928311620003015760049687548581811c91168015620002f6575b8b821014620002e3578281116200029b575b508991841160011462000234579383949184925f9562000228575b50501b925f19911b1c19161783555b85156200021257600580546001600160a01b0319811688179091558691167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e05f80a360805260025490828201809211620001ff57506002555f8381528083528481208054830190558451918252917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef91a3516109999081620004968239608051816105180152f35b601190634e487b7160e01b5f525260245ffd5b8651631e4fbdf760e01b81525f81850152602490fd5b015193505f8062000148565b9190601f19841692885f52848b5f20945f5b8d8983831062000283575050501062000269575b50505050811b01835562000157565b01519060f8845f19921b161c191690555f8080806200025a565b86860151895590970196948501948893500162000246565b885f528a5f208380870160051c8201928d8810620002d9575b0160051c019086905b828110620002cd5750506200012d565b5f8155018690620002bd565b92508192620002b4565b602289634e487b7160e01b5f525260245ffd5b90607f16906200011b565b634e487b7160e01b5f52604160045260245ffd5b015190505f80620000ed565b5f8681528d8120899550929190601f198516908f5b8282106200036e575050841162000356575b505050811b018255620000fe565b01515f1960f88460031b161c191690555f808062000348565b8385015186558b979095019493840193018f62000336565b90919250855f5284825f209181860160051c8301938610620003d2575b918991869594930160051c01915b828110620003c357508d9150620000d6565b5f8155869550879101620003b1565b92508192620003a3565b634e487b7160e01b5f52602260045260245ffd5b92607f1692620000be565b5f80fd5b6040519190601f01601f191682016001600160401b038111838210176200030157604052565b919080601f84011215620003fb5782516001600160401b03811162000301576020906200045b601f8201601f19168301620003ff565b92818452828287010111620003fb575f5b818110620004815750825f9394955001015290565b85810183015184820184015282016200046c56fe608060409080825260049081361015610016575f80fd5b5f3560e01c90816306fdde03146106f457508063095ea7b31461064b57806318160ddd1461062d57806323b872dd1461053c578063313ce567146104ff57806340c10f191461045157806342966c681461039d57806370a0823114610367578063715018a61461030c5780638da5cb5b146102e457806395d89b41146101c4578063a9059cbb14610194578063dd62ed3e1461014b5763f2fde38b146100ba575f80fd5b34610147576020366003190112610147576100d3610831565b906100dc610937565b6001600160a01b03918216928315610131575050600554826bffffffffffffffffffffffff60a01b821617600555167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e05f80a3005b905f6024925191631e4fbdf760e01b8352820152fd5b5f80fd5b8234610147578060031936011261014757602090610167610831565b61016f610847565b9060018060a01b038091165f5260018452825f2091165f528252805f20549051908152f35b82346101475780600319360112610147576020906101bd6101b3610831565b602435903361085d565b5160018152f35b509034610147575f366003190112610147578051905f835460018160011c90600183169283156102da575b60209384841081146102c7578388529081156102ab5750600114610257575b505050829003601f01601f191682019267ffffffffffffffff84118385101761024457508291826102409252826107ea565b0390f35b604190634e487b7160e01b5f525260245ffd5b5f878152929350837f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b5b83851061029757505050508301015f808061020e565b805488860183015293019284908201610281565b60ff1916878501525050151560051b84010190505f808061020e565b602289634e487b7160e01b5f525260245ffd5b91607f16916101ef565b8234610147575f3660031901126101475760055490516001600160a01b039091168152602090f35b34610147575f36600319011261014757610324610937565b600580546001600160a01b031981169091555f906001600160a01b03167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08280a3005b8234610147576020366003190112610147576020906001600160a01b0361038c610831565b165f525f8252805f20549051908152f35b50903461014757602036600319011261014757813590331561043c57335f525f602052805f2054928284106104105750815f933385528460205203818420558160025403600255519081527fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef60203392a3005b905163391434e360e21b8152339181019182526020820193909352604081019190915281906060010390fd5b51634b637e8f60e11b81525f81840152602490fd5b50903461014757806003193601126101475761046b610831565b9060243591610478610937565b6001600160a01b03169283156104ea57600254908382018092116104d757505f927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9260209260025585855284835280852082815401905551908152a3005b601190634e487b7160e01b5f525260245ffd5b5f602492519163ec442f0560e01b8352820152fd5b8234610147575f366003190112610147576020905160ff7f0000000000000000000000000000000000000000000000000000000000000000168152f35b503461014757606036600319011261014757610556610831565b61055e610847565b906044359260018060a01b038216805f526001602052855f20335f52602052855f2054915f198310610599575b6020876101bd88888861085d565b8583106106015781156105eb5733156105d557505f908152600160209081528682203383528152908690209185900390915582906101bd61058b565b6024905f885191634a1406b160e11b8352820152fd5b6024905f88519163e602df0560e01b8352820152fd5b8651637dc7a0d960e11b8152339181019182526020820193909352604081018690528291506060010390fd5b8234610147575f366003190112610147576020906002549051908152f35b509034610147578060031936011261014757610665610831565b6024359033156106de576001600160a01b03169081156106c85760209350335f5260018452825f20825f52845280835f205582519081527f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925843392a35160018152f35b8251634a1406b160e11b81525f81860152602490fd5b825163e602df0560e01b81525f81860152602490fd5b90508234610147575f366003190112610147575f60035460018160011c90600183169283156107e0575b60209384841081146102c7578388529081156107c4575060011461076e57505050829003601f01601f191682019267ffffffffffffffff84118385101761024457508291826102409252826107ea565b60035f908152929350837fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b5b8385106107b0575050505083010184808061020e565b80548886018301529301928490820161079a565b60ff1916878501525050151560051b840101905084808061020e565b91607f169161071e565b602080825282518183018190529093925f5b82811061081d57505060409293505f838284010152601f8019910116010190565b8181018601518482016040015285016107fc565b600435906001600160a01b038216820361014757565b602435906001600160a01b038216820361014757565b916001600160a01b0380841692831561091f571692831561090757825f525f60205260405f2054908282106108d55750817fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef92602092855f525f84520360405f2055845f5260405f20818154019055604051908152a3565b60405163391434e360e21b81526001600160a01b03919091166004820152602481019190915260448101829052606490fd5b60405163ec442f0560e01b81525f6004820152602490fd5b604051634b637e8f60e11b81525f6004820152602490fd5b6005546001600160a01b0316330361094b57565b60405163118cdaa760e01b8152336004820152602490fdfea2646970667358221220f5cbea25cae476e6b7685ebf9f58926471b1be496b40081ebfaef48f82efe3af64736f6c63430008180033' as `0x${string}`;

// Hook for LS-LMSR market creation (recommended for new markets)
export function useLSLMSRMarketCreate() {
  const { address } = useAccount();
  const publicClient = usePublicClient();
  const { data: walletClient } = useWalletClient();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const createMarket = useCallback(async (
    config: LSLMSRMarketConfig,
    addLog: (msg: string, type: LogType, txHash?: string) => void
  ): Promise<{ marketAddress: Address; yesToken: Address; noToken: Address; txHash: string } | null> => {
    if (!address || !walletClient || !publicClient) {
      setError('Wallet not connected');
      addLog('Wallet not connected', 'error');
      return null;
    }

    if (LSLMSR_BYTECODE === '0x') {
      setError('LS-LMSR bytecode not compiled. Please compile contracts/LSLMSR.sol first.');
      addLog('LS-LMSR bytecode not available. Compile the contract first.', 'error');
      return null;
    }

    setIsLoading(true);
    setError(null);

    try {
      addLog(`Deploying LS-LMSR market with =${config.alpha}...`, 'pending');

      const resolutionTime = BigInt(Math.floor(new Date(config.resolutionDate).getTime() / 1000));
      const oracle = (config.oracle || address) as Address;
      const alpha = parseEther(config.alpha);
      const minLiquidity = parseEther(config.minLiquidity);
      const initialYesShares = parseEther(config.initialYesShares);
      const initialNoShares = parseEther(config.initialNoShares);
      const protocolFeeRecipient = (config.protocolFeeRecipient || address) as Address;

      // Deploy LSLMSR contract
      const hash = await walletClient.deployContract({
        abi: LSLMSR_ABI,
        bytecode: LSLMSR_BYTECODE,
        args: [
          config.question,
          resolutionTime,
          oracle,
          alpha,
          minLiquidity,
          initialYesShares,
          initialNoShares,
          config.yesName,
          config.yesSymbol,
          config.noName,
          config.noSymbol,
          protocolFeeRecipient,
        ],
      });

      addLog('Waiting for confirmation...', 'pending', hash);

      const receipt = await publicClient.waitForTransactionReceipt({ hash });

      if (!receipt.contractAddress) {
        throw new Error('Contract deployment failed - no contract address in receipt');
      }

      const marketAddress = receipt.contractAddress as Address;
      addLog(`LS-LMSR Market deployed: ${marketAddress}`, 'success', hash);

      // Add initial liquidity if specified
      if (config.initialLiquidity && parseFloat(config.initialLiquidity) > 0) {
        addLog('Adding initial liquidity...', 'pending');
        const liquidityHash = await walletClient.writeContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'addLiquidity',
          value: parseEther(config.initialLiquidity),
        });
        await publicClient.waitForTransactionReceipt({ hash: liquidityHash });
        addLog(`Added ${config.initialLiquidity} MON liquidity`, 'success', liquidityHash);
      }

      // Get token addresses from deployed contract
      const yesToken = await publicClient.readContract({
        address: marketAddress,
        abi: LSLMSR_ABI,
        functionName: 'yesToken',
      }) as Address;

      const noToken = await publicClient.readContract({
        address: marketAddress,
        abi: LSLMSR_ABI,
        functionName: 'noToken',
      }) as Address;

      addLog(`YES Token: ${yesToken}`, 'info');
      addLog(`NO Token: ${noToken}`, 'info');

      return { marketAddress, yesToken, noToken, txHash: hash };
    } catch (err: any) {
      const errorMsg = err.shortMessage || err.message || 'Failed to create market';
      setError(errorMsg);
      addLog(`Error: ${errorMsg}`, 'error');
      console.error('LS-LMSR Market creation error:', err);
      return null;
    } finally {
      setIsLoading(false);
    }
  }, [address, walletClient, publicClient]);

  return { createMarket, isLoading, error };
}

// Hook for legacy LMSR market creation
export function useLMSRMarketCreate() {
  const { address } = useAccount();
  const publicClient = usePublicClient();
  const { data: walletClient } = useWalletClient();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const createMarket = useCallback(async (
    config: LMSRMarketConfig,
    addLog: (msg: string, type: LogType, txHash?: string) => void
  ): Promise<{ marketAddress: Address; yesToken: Address; noToken: Address; txHash: string } | null> => {
    if (!address || !walletClient || !publicClient) {
      setError('Wallet not connected');
      addLog('Wallet not connected', 'error');
      return null;
    }

    setIsLoading(true);
    setError(null);

    try {
      addLog(`Deploying LMSR market...`, 'pending');

      const resolutionTime = BigInt(Math.floor(new Date(config.resolutionDate).getTime() / 1000));
      const oracle = (config.oracle || address) as Address;
      const liquidityParam = parseEther(config.liquidityParam);

      // Deploy LMSR contract (constructor is not payable)
      const hash = await walletClient.deployContract({
        abi: LMSR_ABI,
        bytecode: LMSR_BYTECODE,
        args: [
          config.question,
          resolutionTime,
          oracle,
          liquidityParam,
          config.yesName,
          config.yesSymbol,
          config.noName,
          config.noSymbol,
        ],
      });

      addLog('Waiting for confirmation...', 'pending', hash);

      const receipt = await publicClient.waitForTransactionReceipt({ hash });

      if (!receipt.contractAddress) {
        throw new Error('Contract deployment failed - no contract address in receipt');
      }

      const marketAddress = receipt.contractAddress as Address;
      addLog(`Market deployed: ${marketAddress}`, 'success', hash);

      // Add initial liquidity if specified
      if (config.initialLiquidity && parseFloat(config.initialLiquidity) > 0) {
        addLog('Adding initial liquidity...', 'pending');
        const liquidityHash = await walletClient.writeContract({
          address: marketAddress,
          abi: LMSR_ABI,
          functionName: 'addLiquidity',
          value: parseEther(config.initialLiquidity),
        });
        await publicClient.waitForTransactionReceipt({ hash: liquidityHash });
        addLog(`Added ${config.initialLiquidity} MON liquidity`, 'success', liquidityHash);
      }

      // Get token addresses from deployed contract
      const yesToken = await publicClient.readContract({
        address: marketAddress,
        abi: LMSR_ABI,
        functionName: 'yesToken',
      }) as Address;

      const noToken = await publicClient.readContract({
        address: marketAddress,
        abi: LMSR_ABI,
        functionName: 'noToken',
      }) as Address;

      addLog(`YES Token: ${yesToken}`, 'info');
      addLog(`NO Token: ${noToken}`, 'info');

      return { marketAddress, yesToken, noToken, txHash: hash };
    } catch (err: any) {
      const errorMsg = err.shortMessage || err.message || 'Failed to create market';
      setError(errorMsg);
      addLog(`Error: ${errorMsg}`, 'error');
      console.error('Market creation error:', err);
      return null;
    } finally {
      setIsLoading(false);
    }
  }, [address, walletClient, publicClient]);

  return { createMarket, isLoading, error };
}

// Hook for buying shares
export function useLMSRBuy() {
  const { address } = useAccount();
  const publicClient = usePublicClient();
  const { data: walletClient } = useWalletClient();
  const [isLoading, setIsLoading] = useState(false);

  const buy = useCallback(async (
    marketAddress: Address,
    isYes: boolean,
    amount: string,
    minShares: string,
    addLog: (msg: string, type: LogType, txHash?: string) => void
  ): Promise<{ success: boolean; txHash?: string; shares?: string }> => {
    if (!address || !walletClient || !publicClient) {
      addLog('Wallet not connected', 'error');
      return { success: false };
    }

    setIsLoading(true);

    try {
      addLog(`Buying ${isYes ? 'YES' : 'NO'} shares...`, 'pending');

      const hash = await walletClient.writeContract({
        address: marketAddress,
        abi: LMSR_ABI,
        functionName: 'buy',
        args: [isYes, parseEther(minShares || '0')],
        value: parseEther(amount),
      });

      const receipt = await publicClient.waitForTransactionReceipt({ hash });

      // Parse the SharesPurchased event to get the shares amount
      let shares = '0';
      for (const log of receipt.logs) {
        try {
          const decoded = decodeEventLog({
            abi: LMSR_ABI,
            data: log.data,
            topics: log.topics,
          });
          if (decoded.eventName === 'SharesPurchased') {
            const args = decoded.args as unknown as { shares: bigint };
            shares = formatEther(args.shares);
            break;
          }
        } catch {
          // Not our event, skip
        }
      }

      addLog(`Bought ${shares} ${isYes ? 'YES' : 'NO'} shares`, 'success', hash);
      return { success: true, txHash: hash, shares };
    } catch (err: any) {
      addLog(`Error: ${err.shortMessage || err.message}`, 'error');
      return { success: false };
    } finally {
      setIsLoading(false);
    }
  }, [address, walletClient, publicClient]);

  return { buy, isLoading };
}

// ERC20 ABI for token approval
const ERC20_ABI = [
  {
    name: 'approve',
    type: 'function',
    inputs: [
      { name: 'spender', type: 'address' },
      { name: 'amount', type: 'uint256' },
    ],
    outputs: [{ type: 'bool' }],
    stateMutability: 'nonpayable',
  },
  {
    name: 'allowance',
    type: 'function',
    inputs: [
      { name: 'owner', type: 'address' },
      { name: 'spender', type: 'address' },
    ],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
  {
    name: 'balanceOf',
    type: 'function',
    inputs: [{ name: 'account', type: 'address' }],
    outputs: [{ type: 'uint256' }],
    stateMutability: 'view',
  },
] as const;

// Hook for selling shares
export function useLMSRSell() {
  const { address } = useAccount();
  const publicClient = usePublicClient();
  const { data: walletClient } = useWalletClient();
  const [isLoading, setIsLoading] = useState(false);

  const sell = useCallback(async (
    marketAddress: Address,
    isYes: boolean,
    sharesToSell: string,
    minPayout: string,
    addLog: (msg: string, type: LogType, txHash?: string) => void
  ): Promise<{ success: boolean; txHash?: string; shares?: string }> => {
    if (!address || !walletClient || !publicClient) {
      addLog('Wallet not connected', 'error');
      return { success: false };
    }

    setIsLoading(true);

    try {
      const sharesAmount = parseEther(sharesToSell);

      // Get the token address
      const tokenAddress = await publicClient.readContract({
        address: marketAddress,
        abi: LMSR_ABI,
        functionName: isYes ? 'yesToken' : 'noToken',
      }) as Address;

      addLog(`Checking ${isYes ? 'YES' : 'NO'} token allowance...`, 'pending');

      // Check current allowance
      const allowance = await publicClient.readContract({
        address: tokenAddress,
        abi: ERC20_ABI,
        functionName: 'allowance',
        args: [address, marketAddress],
      }) as bigint;

      // If allowance is insufficient, approve
      if (allowance < sharesAmount) {
        addLog(`Approving ${isYes ? 'YES' : 'NO'} tokens...`, 'pending');

        const approveHash = await walletClient.writeContract({
          address: tokenAddress,
          abi: ERC20_ABI,
          functionName: 'approve',
          args: [marketAddress, sharesAmount],
        });

        await publicClient.waitForTransactionReceipt({ hash: approveHash });
        addLog(`Approved ${sharesToSell} ${isYes ? 'YES' : 'NO'} tokens`, 'success', approveHash);
      }

      addLog(`Selling ${sharesToSell} ${isYes ? 'YES' : 'NO'} shares...`, 'pending');

      const hash = await walletClient.writeContract({
        address: marketAddress,
        abi: LMSR_ABI,
        functionName: 'sell',
        args: [isYes, sharesAmount, parseEther(minPayout || '0')],
      });

      const receipt = await publicClient.waitForTransactionReceipt({ hash });

      // Parse the SharesSold event to get the actual shares sold
      let shares = sharesToSell;
      for (const log of receipt.logs) {
        try {
          const decoded = decodeEventLog({
            abi: LMSR_ABI,
            data: log.data,
            topics: log.topics,
          });
          if (decoded.eventName === 'SharesSold') {
            const args = decoded.args as unknown as { shares: bigint };
            shares = formatEther(args.shares);
            break;
          }
        } catch {
          // Not our event, skip
        }
      }

      addLog(`Sold ${shares} ${isYes ? 'YES' : 'NO'} shares`, 'success', hash);
      return { success: true, txHash: hash, shares };
    } catch (err: any) {
      addLog(`Error: ${err.shortMessage || err.message}`, 'error');
      return { success: false };
    } finally {
      setIsLoading(false);
    }
  }, [address, walletClient, publicClient]);

  return { sell, isLoading };
}

// Hook for resolving market
export function useLMSRResolve() {
  const { address } = useAccount();
  const publicClient = usePublicClient();
  const { data: walletClient } = useWalletClient();
  const [isLoading, setIsLoading] = useState(false);

  const resolve = useCallback(async (
    marketAddress: Address,
    yesWins: boolean,
    addLog: (msg: string, type: LogType, txHash?: string) => void
  ): Promise<boolean> => {
    if (!address || !walletClient || !publicClient) {
      addLog('Wallet not connected', 'error');
      return false;
    }

    setIsLoading(true);

    try {
      addLog(`Resolving market: ${yesWins ? 'YES' : 'NO'} wins...`, 'pending');

      const hash = await walletClient.writeContract({
        address: marketAddress,
        abi: LMSR_ABI,
        functionName: 'resolve',
        args: [yesWins],
      });

      await publicClient.waitForTransactionReceipt({ hash });

      addLog(`Market resolved: ${yesWins ? 'YES' : 'NO'} wins`, 'success', hash);
      return true;
    } catch (err: any) {
      addLog(`Error: ${err.shortMessage || err.message}`, 'error');
      return false;
    } finally {
      setIsLoading(false);
    }
  }, [address, walletClient, publicClient]);

  return { resolve, isLoading };
}

// Hook for redeeming winnings
export function useLMSRRedeem() {
  const { address } = useAccount();
  const publicClient = usePublicClient();
  const { data: walletClient } = useWalletClient();
  const [isLoading, setIsLoading] = useState(false);

  const redeem = useCallback(async (
    marketAddress: Address,
    addLog: (msg: string, type: LogType, txHash?: string) => void
  ): Promise<{ success: boolean; txHash?: string; shares?: string; payout?: string; yesWins?: boolean }> => {
    if (!address || !walletClient || !publicClient) {
      addLog('Wallet not connected', 'error');
      return { success: false };
    }

    setIsLoading(true);

    try {
      // First get market info to determine winning outcome and check if resolved
      const info = await publicClient.readContract({
        address: marketAddress,
        abi: LMSR_ABI,
        functionName: 'getMarketInfo',
      }) as [string, bigint, Address, bigint, bigint, bigint, bigint, bigint, boolean, boolean];

      const resolved = info[8];
      const yesWins = info[9];

      if (!resolved) {
        addLog('Market is not resolved yet', 'error');
        return { success: false };
      }

      // Get the winning token address
      const winningTokenAddress = await publicClient.readContract({
        address: marketAddress,
        abi: LMSR_ABI,
        functionName: yesWins ? 'yesToken' : 'noToken',
      }) as Address;

      // Check user's balance of winning tokens
      const balance = await publicClient.readContract({
        address: winningTokenAddress,
        abi: ERC20_ABI,
        functionName: 'balanceOf',
        args: [address],
      }) as bigint;

      if (balance === 0n) {
        addLog('No winning tokens to redeem', 'error');
        return { success: false };
      }

      addLog(`Found ${formatEther(balance)} winning tokens`, 'info');

      // Check allowance and approve if needed
      const allowance = await publicClient.readContract({
        address: winningTokenAddress,
        abi: ERC20_ABI,
        functionName: 'allowance',
        args: [address, marketAddress],
      }) as bigint;

      if (allowance < balance) {
        addLog('Approving tokens for redemption...', 'pending');
        const approveHash = await walletClient.writeContract({
          address: winningTokenAddress,
          abi: ERC20_ABI,
          functionName: 'approve',
          args: [marketAddress, balance],
        });
        await publicClient.waitForTransactionReceipt({ hash: approveHash });
        addLog('Tokens approved', 'success');
      }

      addLog(`Redeeming winnings...`, 'pending');

      const hash = await walletClient.writeContract({
        address: marketAddress,
        abi: LMSR_ABI,
        functionName: 'redeem',
      });

      const receipt = await publicClient.waitForTransactionReceipt({ hash });

      // Try to parse the Redeemed event to get shares and payout
      let shares = '0';
      let payout = '0';
      for (const log of receipt.logs) {
        try {
          const decoded = decodeEventLog({
            abi: LMSR_ABI,
            data: log.data,
            topics: log.topics,
          });
          if (decoded.eventName === 'Redeemed') {
            const args = decoded.args as unknown as { user: Address; shares: bigint; payout: bigint };
            shares = formatEther(args.shares);
            payout = formatEther(args.payout);
          }
        } catch {
          // Not this event, continue
        }
      }

      addLog(`Redeemed ${shares} shares for ${payout} MON`, 'success', hash);
      return { success: true, txHash: hash, shares, payout, yesWins };
    } catch (err: any) {
      addLog(`Error: ${err.shortMessage || err.message}`, 'error');
      return { success: false };
    } finally {
      setIsLoading(false);
    }
  }, [address, walletClient, publicClient]);

  return { redeem, isLoading };
}

// Hook for reading market data
export function useLMSRMarketData(marketAddress: Address | undefined) {
  const { data: marketInfo, refetch } = useReadContract({
    address: marketAddress,
    abi: LMSR_ABI,
    functionName: 'getMarketInfo',
    query: { enabled: !!marketAddress },
  });

  if (!marketInfo) {
    return { marketInfo: null, refetch };
  }

  const [question, resolutionTime, oracle, yesPrice, noPrice, yesShares, noShares, totalCollateral, resolved, yesWins] = marketInfo as [string, bigint, Address, bigint, bigint, bigint, bigint, bigint, boolean, boolean];

  return {
    marketInfo: {
      question,
      resolutionTime,
      oracle,
      yesPrice,
      noPrice,
      yesShares,
      noShares,
      totalCollateral,
      resolved,
      yesWins,
    } as MarketInfo,
    refetch,
  };
}

// Hook for estimating shares using binary search on getCost
// Client-side LMSR math functions (matches Solidity implementation)
function lmsrExp(x: number): number {
  // Cap x to prevent overflow (e^6  403)
  if (x > 6) x = 6;
  return Math.exp(x);
}

function lmsrLn(x: number): number {
  if (x <= 1) return 0;
  return Math.log(x);
}

function lmsrCostFunction(yesShares: number, noShares: number, b: number): number {
  // C(q) = b * ln(e^(qYes/b) + e^(qNo/b))
  const expYes = lmsrExp(yesShares / b);
  const expNo = lmsrExp(noShares / b);
  return b * lmsrLn(expYes + expNo);
}

function lmsrGetCost(
  currentYesShares: number,
  currentNoShares: number,
  b: number,
  isYes: boolean,
  sharesToBuy: number
): number {
  const newYes = isYes ? currentYesShares + sharesToBuy : currentYesShares;
  const newNo = isYes ? currentNoShares : currentNoShares + sharesToBuy;

  const newCost = lmsrCostFunction(newYes, newNo, b);
  const currentCost = lmsrCostFunction(currentYesShares, currentNoShares, b);

  return Math.max(0, newCost - currentCost);
}

export function useLMSREstimateShares() {
  const publicClient = usePublicClient();

  const estimateShares = useCallback(async (
    marketAddress: Address,
    isYes: boolean,
    paymentAmount: string
  ): Promise<string> => {
    if (!publicClient || !paymentAmount || parseFloat(paymentAmount) <= 0) {
      return '0';
    }

    try {
      const payment = parseFloat(paymentAmount);

      // Single RPC call to get market state
      const [info, b] = await Promise.all([
        publicClient.readContract({
          address: marketAddress,
          abi: LMSR_ABI,
          functionName: 'getMarketInfo',
        }) as Promise<[string, bigint, Address, bigint, bigint, bigint, bigint, bigint, boolean, boolean]>,
        publicClient.readContract({
          address: marketAddress,
          abi: LMSR_ABI,
          functionName: 'b',
        }) as Promise<bigint>,
      ]);

      const yesShares = Number(formatEther(info[5]));
      const noShares = Number(formatEther(info[6]));
      const bValue = Number(formatEther(b));

      // Client-side binary search (instant, no RPC calls)
      let low = 0;
      let high = payment * 10;

      for (let i = 0; i < 50; i++) {
        const mid = (low + high) / 2;
        const cost = lmsrGetCost(yesShares, noShares, bValue, isYes, mid);

        if (cost <= payment) {
          low = mid;
        } else {
          high = mid;
        }

        if (high - low < 0.0001) break;
      }

      return low.toFixed(6);
    } catch (err) {
      console.error('Error estimating shares:', err);
      return '0';
    }
  }, [publicClient]);

  return { estimateShares };
}

// ============ LS-LMSR Specific Hooks ============

// Hook for reading LS-LMSR market data (extended with probability and price sum)
export function useLSLMSRMarketData(marketAddress: Address | undefined) {
  const { data: marketInfo, refetch } = useReadContract({
    address: marketAddress,
    abi: LSLMSR_ABI,
    functionName: 'getMarketInfo',
    query: { enabled: !!marketAddress },
  });

  if (!marketInfo) {
    return { marketInfo: null, refetch };
  }

  const [
    question,
    resolutionTime,
    oracle,
    yesPrice,
    noPrice,
    yesProbability,
    noProbability,
    yesShares,
    noShares,
    totalCollateral,
    liquidityParam,
    priceSum,
    resolved,
    yesWins
  ] = marketInfo as [string, bigint, Address, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, boolean, boolean];

  return {
    marketInfo: {
      question,
      resolutionTime,
      oracle,
      yesPrice,
      noPrice,
      yesProbability,
      noProbability,
      yesShares,
      noShares,
      totalCollateral,
      liquidityParam,
      priceSum,
      resolved,
      yesWins,
    } as LSLMSRMarketInfo,
    refetch,
  };
}

// LS-LMSR client-side math functions (dynamic b)
function lslmsrLiquidityParameter(yesShares: number, noShares: number, alpha: number, minLiquidity: number): number {
  const totalShares = yesShares + noShares;
  const dynamicB = alpha * totalShares;
  return Math.max(dynamicB, minLiquidity);
}

function lslmsrCostFunction(yesShares: number, noShares: number, alpha: number, minLiquidity: number): number {
  const b = lslmsrLiquidityParameter(yesShares, noShares, alpha, minLiquidity);
  const expYes = lmsrExp(yesShares / b);
  const expNo = lmsrExp(noShares / b);
  return b * lmsrLn(expYes + expNo);
}

function lslmsrGetCost(
  currentYesShares: number,
  currentNoShares: number,
  alpha: number,
  minLiquidity: number,
  isYes: boolean,
  sharesToBuy: number
): number {
  const newYes = isYes ? currentYesShares + sharesToBuy : currentYesShares;
  const newNo = isYes ? currentNoShares : currentNoShares + sharesToBuy;

  const newCost = lslmsrCostFunction(newYes, newNo, alpha, minLiquidity);
  const currentCost = lslmsrCostFunction(currentYesShares, currentNoShares, alpha, minLiquidity);

  return Math.max(0, newCost - currentCost);
}

// Hook for estimating shares in LS-LMSR markets
export function useLSLMSREstimateShares() {
  const publicClient = usePublicClient();

  const estimateShares = useCallback(async (
    marketAddress: Address,
    isYes: boolean,
    paymentAmount: string
  ): Promise<string> => {
    if (!publicClient || !paymentAmount || parseFloat(paymentAmount) <= 0) {
      return '0';
    }

    try {
      const payment = parseFloat(paymentAmount);

      // Get market state and parameters
      const [info, alpha, minLiquidity] = await Promise.all([
        publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'getMarketInfo',
        }) as Promise<[string, bigint, Address, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, boolean, boolean]>,
        publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'alpha',
        }) as Promise<bigint>,
        publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'minLiquidity',
        }) as Promise<bigint>,
      ]);

      const yesShares = Number(formatEther(info[7])); // index 7 in LS-LMSR
      const noShares = Number(formatEther(info[8])); // index 8 in LS-LMSR
      const alphaValue = Number(formatEther(alpha));
      const minLiquidityValue = Number(formatEther(minLiquidity));

      // Client-side binary search with dynamic b
      let low = 0;
      let high = payment * 10;

      for (let i = 0; i < 50; i++) {
        const mid = (low + high) / 2;
        const cost = lslmsrGetCost(yesShares, noShares, alphaValue, minLiquidityValue, isYes, mid);

        if (cost <= payment) {
          low = mid;
        } else {
          high = mid;
        }

        if (high - low < 0.0001) break;
      }

      return low.toFixed(6);
    } catch (err) {
      console.error('Error estimating LS-LMSR shares:', err);
      return '0';
    }
  }, [publicClient]);

  return { estimateShares };
}

// Generic market type detection
export function useMarketType(marketAddress: Address | undefined) {
  const publicClient = usePublicClient();
  const [marketType, setMarketType] = useState<'LMSR' | 'LSLMSR' | null>(null);

  useEffect(() => {
    const detectType = async () => {
      if (!publicClient || !marketAddress) {
        setMarketType(null);
        return;
      }

      try {
        // Try to read alpha - only exists in LS-LMSR
        await publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'alpha',
        });
        setMarketType('LSLMSR');
      } catch {
        // If alpha doesn't exist, it's legacy LMSR
        setMarketType('LMSR');
      }
    };

    detectType();
  }, [publicClient, marketAddress]);

  return marketType;
}

// ============ Unified Hooks for Trading Interface ============

// Unified market data hook that auto-detects market type
export function useUnifiedMarketData(marketAddress: Address | undefined) {
  const publicClient = usePublicClient();
  const [marketInfo, setMarketInfo] = useState<MarketInfo | null>(null);
  const [marketType, setMarketType] = useState<'LMSR' | 'LSLMSR' | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const refetch = useCallback(async () => {
    if (!publicClient || !marketAddress) {
      setMarketInfo(null);
      setMarketType(null);
      return;
    }

    setIsLoading(true);
    try {
      // Try LS-LMSR first (check for alpha)
      try {
        await publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'alpha',
        });

        // It's LS-LMSR
        setMarketType('LSLMSR');
        const info = await publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'getMarketInfo',
        }) as [string, bigint, Address, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, boolean, boolean];

        setMarketInfo({
          question: info[0],
          resolutionTime: info[1],
          oracle: info[2],
          yesPrice: info[3],
          noPrice: info[4],
          yesShares: info[7],
          noShares: info[8],
          totalCollateral: info[9],
          resolved: info[12],
          yesWins: info[13],
        });
      } catch {
        // It's legacy LMSR
        setMarketType('LMSR');
        const info = await publicClient.readContract({
          address: marketAddress,
          abi: LMSR_ABI,
          functionName: 'getMarketInfo',
        }) as [string, bigint, Address, bigint, bigint, bigint, bigint, bigint, boolean, boolean];

        setMarketInfo({
          question: info[0],
          resolutionTime: info[1],
          oracle: info[2],
          yesPrice: info[3],
          noPrice: info[4],
          yesShares: info[5],
          noShares: info[6],
          totalCollateral: info[7],
          resolved: info[8],
          yesWins: info[9],
        });
      }
    } catch (err) {
      console.error('Error fetching market data:', err);
      setMarketInfo(null);
    } finally {
      setIsLoading(false);
    }
  }, [publicClient, marketAddress]);

  useEffect(() => {
    refetch();
  }, [refetch]);

  return { marketInfo, marketType, isLoading, refetch };
}

// Unified share estimation that auto-detects market type
export function useUnifiedEstimateShares() {
  const publicClient = usePublicClient();

  const estimateShares = useCallback(async (
    marketAddress: Address,
    isYes: boolean,
    paymentAmount: string
  ): Promise<string> => {
    if (!publicClient || !paymentAmount || parseFloat(paymentAmount) <= 0) {
      return '0';
    }

    try {
      const payment = parseFloat(paymentAmount);

      // Detect market type by trying to read alpha
      let isLSLMSR = false;
      try {
        await publicClient.readContract({
          address: marketAddress,
          abi: LSLMSR_ABI,
          functionName: 'alpha',
        });
        isLSLMSR = true;
      } catch {
        isLSLMSR = false;
      }

      if (isLSLMSR) {
        // LS-LMSR estimation
        const [info, alpha, minLiquidity] = await Promise.all([
          publicClient.readContract({
            address: marketAddress,
            abi: LSLMSR_ABI,
            functionName: 'getMarketInfo',
          }) as Promise<[string, bigint, Address, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, bigint, boolean, boolean]>,
          publicClient.readContract({
            address: marketAddress,
            abi: LSLMSR_ABI,
            functionName: 'alpha',
          }) as Promise<bigint>,
          publicClient.readContract({
            address: marketAddress,
            abi: LSLMSR_ABI,
            functionName: 'minLiquidity',
          }) as Promise<bigint>,
        ]);

        const yesShares = Number(formatEther(info[7]));
        const noShares = Number(formatEther(info[8]));
        const alphaValue = Number(formatEther(alpha));
        const minLiquidityValue = Number(formatEther(minLiquidity));

        let low = 0;
        let high = payment * 10;

        for (let i = 0; i < 50; i++) {
          const mid = (low + high) / 2;
          const cost = lslmsrGetCost(yesShares, noShares, alphaValue, minLiquidityValue, isYes, mid);

          if (cost <= payment) {
            low = mid;
          } else {
            high = mid;
          }

          if (high - low < 0.0001) break;
        }

        return low.toFixed(6);
      } else {
        // Legacy LMSR estimation
        const [info, b] = await Promise.all([
          publicClient.readContract({
            address: marketAddress,
            abi: LMSR_ABI,
            functionName: 'getMarketInfo',
          }) as Promise<[string, bigint, Address, bigint, bigint, bigint, bigint, bigint, boolean, boolean]>,
          publicClient.readContract({
            address: marketAddress,
            abi: LMSR_ABI,
            functionName: 'b',
          }) as Promise<bigint>,
        ]);

        const yesShares = Number(formatEther(info[5]));
        const noShares = Number(formatEther(info[6]));
        const bValue = Number(formatEther(b));

        let low = 0;
        let high = payment * 10;

        for (let i = 0; i < 50; i++) {
          const mid = (low + high) / 2;
          const cost = lmsrGetCost(yesShares, noShares, bValue, isYes, mid);

          if (cost <= payment) {
            low = mid;
          } else {
            high = mid;
          }

          if (high - low < 0.0001) break;
        }

        return low.toFixed(6);
      }
    } catch (err) {
      console.error('Error estimating shares:', err);
      return '0';
    }
  }, [publicClient]);

  return { estimateShares };
}
